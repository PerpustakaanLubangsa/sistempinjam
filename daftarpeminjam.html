<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Daftar Peminjam - Card Minimalis (Ditingkatkan)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* --- BOX-SIZING UNIVERSAL (GARANSI KONSISTENSI LAYOUT) --- */
*, *::before, *::after {
    box-sizing: border-box;
}

/* --- VARIABEL DASAR & Layout --- */
:root {
    --primary-blue: #3498db;
    --danger-red: #e74c3c;
    --success-green: #2ecc71;
    --text-dark: #2c3e50;
    --text-muted: #7f8c8d;
    --bg-light: #f4f7f6;
    --border-light: #eee;
}

/* --- Keyframes untuk Animasi Peringatan --- */
@keyframes blink-flash {
    0%, 100% { 
        background-color: var(--danger-red); 
        box-shadow: 0 0 15px rgba(231, 76, 60, 0.8); /* Flash lebih terang */
        transform: scale(1);
    }
    50% { 
        background-color: #c0392b; /* Warna sedikit lebih gelap */
        box-shadow: 0 0 5px rgba(231, 76, 60, 0.3); 
        transform: scale(0.99);
    }
}

body { 
    font-family: 'Poppins', sans-serif; 
    background: var(--bg-light); 
    margin: 0; 
    padding: 20px 15px; 
    color: var(--text-dark); 
    position: relative; /* Penting untuk positioning hitungan total */
}

/* --- GAYA BARU UNTUK TOTAL PEMINJAM --- */
#totalPeminjam {
    position: absolute;
    top: 20px;
    right: 15px;
    background: var(--primary-blue);
    color: #fff;
    padding: 8px 15px;
    border-radius: 12px;
    font-size: 1.1em;
    font-weight: 700;
    box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
    z-index: 50;
    line-height: 1;
}
#totalPeminjam i {
    margin-right: 5px;
}
/* Untuk layar yang lebih kecil, geser sedikit */
@media (max-width: 600px) {
    #totalPeminjam {
        top: 65px; /* Geser ke bawah agar tidak terlalu dekat dengan search */
        right: 10px;
        padding: 6px 10px;
        font-size: 0.9em;
    }
}

#searchContainer { 
    margin-bottom: 20px; 
    text-align: center; 
}
#searchInput {
    padding: 10px 18px; 
    border: 2px solid var(--border-light); 
    border-radius: 30px; 
    width: 90%; 
    max-width: 500px; 
    font-size: 1em; 
    transition: border-color 0.3s, box-shadow 0.3s;
}
#searchInput:focus { 
    border-color: var(--primary-blue); 
    box-shadow: 0 0 8px rgba(52, 152, 219, 0.2); 
    outline: none; 
}

/* --- Container Card --- */
#peminjamContainer {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 20px; 
    padding: 0;
    max-width: 1200px;
    margin: auto;
}

/* --- Gaya Card Profil --- */
.peminjam-card {
    background: #ffffff;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
    padding: 15px; 
    transition: box-shadow 0.3s, transform 0.2s; 
    border-left: 6px solid var(--primary-blue); 
    position: relative; 
}
.peminjam-card:hover {
    box-shadow: 0 12px 25px rgba(0,0,0,0.12);
    transform: translateY(-2px); 
}

.peminjam-card.terlambat {
    border-left: 6px solid var(--danger-red);
}


.card-header {
    border-bottom: 1px solid var(--border-light);
    padding-bottom: 10px; 
    margin-bottom: 5px; 
}

.card-title {
    font-size: 1.4em; 
    font-weight: 700;
    color: var(--text-dark);
    margin: 0;
    display: flex;
    align-items: center;
}

.card-subtitle {
    font-size: 0.9em; 
    color: var(--text-muted);
    margin-top: 5px; 
}

/* --- Keterangan Buku --- */
.book-details-wrapper {
    margin-top: 5px; 
    margin-bottom: 10px; 
    padding: 5px 0; 
    border-top: 1px solid #f0f0f0; 
}

.card-detail {
    margin-bottom: 5px; 
    padding: 8px 12px; 
    background: #f8f9fa; 
    border-radius: 8px; 
    border: 1px solid #e9ecef;
    line-height: 1.3;
    display: flex; 
    align-items: flex-start;
}

.card-detail i {
    flex-shrink: 0;
    margin-right: 8px;
    font-size: 1em;
}

.card-detail.main-judul {
    background: #f3f7f8; 
    border-left: 4px solid var(--primary-blue);
    padding: 6px 12px; 
    margin-bottom: 4px; 
}
.card-detail.main-judul span {
    font-size: 1.05em; 
}

.card-detail.other-details {
    padding: 4px 12px; 
    font-size: 0.85em; 
    color: var(--text-muted);
}
.card-detail.other-details i {
    font-size: 0.8em; 
}

/* --- Tanggal Peminjaman/Kembali (Penyesuaian Alignment) --- */
.card-dates {
    margin-top: 10px; 
    padding-top: 8px; 
    display: flex;
    justify-content: space-between;
    border-top: 1px dashed #ecf0f1;
    font-size: 0.9em; 
    gap: 10px; 
}
.date-item {
    text-align: center; 
    flex-grow: 1;
    padding: 3px; 
    background: #fdfdfd;
    border-radius: 8px;
    border: 1px solid #f0f0f0;
}
.date-item span {
    display: block; 
    color: var(--text-muted);
    font-size: 0.85em;
    margin-top: 5px;
    justify-content: center; 
}
.date-item .date-value {
    display: block;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 5px;
}

/* --- Tombol Edit Tanggal (Ikon Kalender sebagai Tombol) --- */
.edit-date-btn {
    background: transparent;
    border: none;
    color: var(--primary-blue);
    cursor: pointer;
    padding: 0;
    margin: 0 auto 5px auto; 
    font-size: 1.1em; 
    display: block;
    transition: color 0.2s;
    outline: none; 
}
.edit-date-btn:hover {
    color: #2980b9;
}


/* --- Pemberitahuan Denda (DITAMBAH ANIMASI) --- */
.denda-notification {
    background-color: var(--danger-red);
    color: #fff;
    padding: 8px 12px; 
    border-radius: 10px;
    margin-top: 10px; 
    font-weight: 700;
    text-align: center;
    box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
    font-size: 0.9em;
    
    /* --- ANIMASI DITAMBAHKAN DI SINI --- */
    animation: blink-flash 1.5s ease-in-out infinite alternate;
}
.denda-notification i {
    margin-right: 8px;
}

/* --- Tombol Aksi (Kembalikan/Perpanjang) --- */
.card-actions {
    text-align: center;
    margin-top: 15px; 
    padding-top: 8px; 
    border-top: 1px solid var(--border-light);
    display: flex; 
    justify-content: space-between;
    gap: 8px;
}

.action-btn {
    flex-grow: 1;
    padding: 7px 12px; 
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95em; 
    font-weight: 600;
    transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; 
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px; 
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.kembali-btn { 
    background:var(--danger-red); 
    color:#fff; 
}
.kembali-btn:hover { 
    background:#c0392b; 
}

.perpanjang-btn { 
    background:var(--success-green); 
    color:#fff; 
}
.perpanjang-btn:hover { 
    background:#27ae60; 
}

/* --- Gaya Modal Kustom (Konfirmasi/Alert) --- */
#customModal, #popupEditTanggal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.65); 
    display: none; 
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

#customModal.show, #popupEditTanggal.show {
    display: flex;
    opacity: 1;
}

.modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    width: 90%;
    max-width: 400px;
    text-align: center;
    transform: translateY(-50px);
    transition: transform 0.3s ease-in-out;
}
#customModal.show .modal-content, #popupEditTanggal.show .modal-content {
    transform: translateY(0);
}

.modal-icon {
    font-size: 3em;
    color: var(--primary-blue); 
    margin-bottom: 15px;
}
.modal-icon.danger { color: var(--danger-red); }
.modal-icon.success { color: var(--success-green); }

.modal-message, #editTanggalTitle {
    font-size: 1.1em;
    line-height: 1.5;
    margin-bottom: 25px;
    white-space: pre-wrap;
    font-weight: 500;
}
.modal-message strong { font-weight: 700; color: var(--text-dark); }

/* --- Tombol di dalam Modal --- */
.modal-buttons { 
    display: flex; 
    justify-content: center; 
    gap: 15px; 
}
.modal-btn { 
    min-width: 100px; 
    flex-grow: 1; 
    padding: 10px 15px; 
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s, box-shadow 0.2s;
}
#cancelBtn {
    background-color: #bdc3c7;
    color: var(--text-dark);
}
#cancelBtn:hover {
    background-color: #95a5a6;
}
#confirmBtn { 
    background-color: var(--primary-blue); 
    color: #fff; 
}
#confirmBtn:hover { 
    background-color: #2980b9; 
}

/* --- Gaya Popup Edit Tanggal Khusus --- */
#dateValueInput {
    padding: 12px;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    width: 100%;
    margin: 15px 0 20px 0;
    font-size: 1em;
}
#btnSimpanTanggal {
    background-color: var(--success-green); 
    color: #fff;
}
#btnSimpanTanggal:hover {
    background-color: #27ae60;
}
</style>
</head>
<body>

<div id="customModal">
    <div class="modal-content">
        <i id="modalIcon" class="modal-icon fas fa-question-circle"></i>
        <div id="modalMessage" class="modal-message"></div>
        <div class="modal-buttons">
            <button id="cancelBtn" class="modal-btn"><i class="fas fa-times"></i> Batal</button>
            <button id="confirmBtn" class="modal-btn"><i class="fas fa-check"></i> Konfirmasi</button>
        </div>
    </div>
</div>

<div id="popupEditTanggal">
    <div class="popup-edit-content modal-content">
        <i class="modal-icon fas fa-calendar-alt"></i>
        <div id="editTanggalTitle"></div>
        <input type="date" id="dateValueInput">
        <div class="modal-buttons">
            <button id="btnBatalTanggal" class="modal-btn"><i class="fas fa-times"></i> Batal</button>
            <button id="btnSimpanTanggal" class="modal-btn"><i class="fas fa-save"></i> Simpan</button>
        </div>
    </div>
</div>

<div id="totalPeminjam"><i class="fas fa-users"></i> Total Peminjam: 0</div>
<div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Cari Nama, Judul Buku, NIS, atau Kode..." oninput="filterTable()" autocomplete="off">
</div>

<div id="peminjamContainer">
    </div>

<div id="statusMessage"></div>

<script>
// --- Konfigurasi Firebase ---
const firebaseConfig = {
    // Ganti dengan konfigurasi Firebase Anda yang sebenarnya
    apiKey: "AIzaSyByw2om-sKHqgCWBDJcE7FEtONoUoJbn9M",
    authDomain: "traying-29bf4.firebaseapp.com",
    databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
    projectId: "traying-29bf4",
    storageBucket: "traying-29bf4.appspot.com",
    messagingSenderId: "42080663883",
    appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const container = document.getElementById("peminjamContainer");
const searchInput = document.getElementById("searchInput");
const statusMessage = document.getElementById('statusMessage');

// --- ELEMEN BARU (Total Peminjam) ---
const totalPeminjamDisplay = document.getElementById("totalPeminjam");

// --- PATH KONSISTEN DENGAN PINJAM.HTML ---
const PEMINJAMAN_PATH = "peminjaman_v2"; 
const DENDA_PER_HARI = 1000; 

// --- STATE GLOBAL ---
let allPeminjamanData = {};
let currentConfirmAction = () => {}; 
let keydownListener; 
let currentEditKey = null; 

// --- Elemen Modal Konfirmasi/Alert ---
const customModal = document.getElementById('customModal');
const modalMessage = document.getElementById('modalMessage');
const modalIcon = document.getElementById('modalIcon');
const confirmBtn = document.getElementById('confirmBtn'); 
const cancelBtn = document.getElementById('cancelBtn');

// --- Elemen Modal Edit Tanggal ---
const popupEditTanggal = document.getElementById('popupEditTanggal');
const editTanggalTitle = document.getElementById('editTanggalTitle');
const dateValueInput = document.getElementById('dateValueInput');
const btnSimpanTanggal = document.getElementById('btnSimpanTanggal');
const btnBatalTanggal = document.getElementById('btnBatalTanggal');


// --- HELPER FUNCTIONS ---

function showStatus(message = '', icon = '', isVisible = true) {
    if (isVisible) {
        statusMessage.className = 'peminjam-card'; 
        statusMessage.innerHTML = `<i class="${icon}" style="margin-right: 10px; color: var(--primary-blue);"></i> ${message}`;
        statusMessage.style.display = 'block';
        container.style.display = 'none'; 
    } else {
        statusMessage.style.display = 'none';
        container.style.display = 'grid'; 
    }
}

function formatRupiah(angka) {
    if (typeof angka !== 'number' || angka < 0) return 'Rp0';
    const reverse = Math.floor(angka).toString().split('').reverse().join('');
    const ribuan = reverse.match(/\d{1,3}/g);
    const result = ribuan.join('.').split('').reverse().join('');
    return 'Rp' + result;
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function hitungDenda(tanggalKembaliStr) {
    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    
    const tglKembali = new Date(tanggalKembaliStr);
    tglKembali.setHours(0, 0, 0, 0); 

    const selisihMs = today.getTime() - tglKembali.getTime();
    
    let hariTerlambat = 0;
    if (selisihMs > 0) {
        hariTerlambat = Math.ceil(selisihMs / (1000 * 60 * 60 * 24)); 
    }
    
    if (hariTerlambat > 0) {
        const totalDenda = hariTerlambat * DENDA_PER_HARI;
        return {
            terlambat: true,
            hari: hariTerlambat,
            denda: totalDenda,
            dendaFormatted: formatRupiah(totalDenda)
        };
    } else {
        return {
            terlambat: false,
            hari: 0,
            denda: 0
        };
    }
}


// --- LOGIKA MODAL KUSTOM (KONFIRMASI/ALERT) ---

function showCustomModal(message, onConfirm, isDanger = false, isAlert = false) {
    modalMessage.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
    currentConfirmAction = onConfirm; 

    modalIcon.className = 'modal-icon fas';
    modalIcon.classList.remove('danger', 'success', 'fa-question-circle', 'fa-exclamation-triangle', 'fa-info-circle');

    if (isAlert) {
        modalIcon.classList.add('fa-info-circle', 'success');
        confirmBtn.innerHTML = '<i class="fas fa-check"></i> OK';
        cancelBtn.style.display = 'none';
    } else {
        modalIcon.classList.add('fa-question-circle');
        confirmBtn.innerHTML = '<i class="fas fa-check"></i> Konfirmasi';
        cancelBtn.style.display = 'inline-block';
        if (isDanger) {
            modalIcon.classList.add('danger', 'fa-exclamation-triangle'); 
            modalIcon.classList.remove('fa-question-circle');
        }
    }
    
    confirmBtn.onclick = handleConfirmClick;
    cancelBtn.onclick = closeModal;

    customModal.classList.add('show');
}

function closeModal() {
    customModal.classList.remove('show');
}

function handleConfirmClick() {
    closeModal();
    currentConfirmAction(); 
}

function customAlert(message) {
    showCustomModal(message, () => {}, false, true); 
}


// --- LOGIKA MODAL EDIT TANGGAL ---

function tutupPopupEditTanggal() {
    popupEditTanggal.classList.remove('show');
}

function updateTanggal(key, dateKey, newDate, newKembali = null) {
    if (!key) {
        return customAlert("🚫 Error: Kunci peminjaman tidak ditemukan.");
    }

    const updateData = {};
    updateData[dateKey] = newDate;
    if (newKembali) {
        updateData.tanggalKembali = newKembali;
    }
    
    db.ref(PEMINJAMAN_PATH + "/" + key).update(updateData).then(() => {
        currentEditKey = null; 
        let successMsg;
        if (dateKey === 'tanggalPinjam') { 
             successMsg = `Tanggal Pinjam berhasil diubah menjadi **${new Date(newDate).toLocaleDateString('id-ID')}**.<br>Tanggal Kembali diperbarui menjadi **${new Date(newKembali).toLocaleDateString('id-ID')}** (otomatis +4 hari).`;
        } else {
             successMsg = `Tanggal Kembali berhasil diubah menjadi **${new Date(newDate).toLocaleDateString('id-ID')}**`;
        }

        customAlert(`🎉 ${successMsg}`);
    }).catch(error => {
        currentEditKey = null; 
        customAlert(`🚫 Gagal mengubah tanggal: ${error.message}`);
    });
}

function handleEditTglPinjam(key, currentTglPinjam) {
    currentEditKey = key; 
    editTanggalTitle.innerHTML = "Pilih **Tanggal Pinjam** baru.";
    dateValueInput.value = currentTglPinjam;
    popupEditTanggal.classList.add('show');
    
    btnSimpanTanggal.onclick = () => {
        const newPinjam = dateValueInput.value;
        if (!newPinjam) {
            return customAlert("Tanggal Pinjam tidak boleh kosong!");
        }
        
        const tglPinjamBaruDate = new Date(newPinjam);
        tglPinjamBaruDate.setHours(0, 0, 0, 0); 
        
        const tglKembaliBaruDate = new Date(tglPinjamBaruDate);
        tglKembaliBaruDate.setDate(tglKembaliBaruDate.getDate() + 4);
        
        const newKembali = formatDate(tglKembaliBaruDate);

        updateTanggal(currentEditKey, 'tanggalPinjam', newPinjam, newKembali); 
        tutupPopupEditTanggal();
    };
}

function handleEditTglKembali(key, currentTglKembali) {
    currentEditKey = key; 
    editTanggalTitle.innerHTML = "Pilih **Tanggal Kembali** baru.";
    dateValueInput.value = currentTglKembali;
    popupEditTanggal.classList.add('show');
    
    btnSimpanTanggal.onclick = () => {
        const newKembali = dateValueInput.value;
        if (!newKembali) {
            return customAlert("Tanggal Kembali tidak boleh kosong!");
        }
        
        updateTanggal(currentEditKey, 'tanggalKembali', newKembali); 
        tutupPopupEditTanggal();
    };
}

btnBatalTanggal.onclick = tutupPopupEditTanggal;


// --- LOGIKA UTAMA: FETCH, RENDER, SEARCH ---
showStatus("Memuat data...", 'fas fa-spinner fa-spin', true); 

db.ref(PEMINJAMAN_PATH).on("value", snap => {
    allPeminjamanData = {};
    if (snap.exists()) {
        snap.forEach(child => {
            allPeminjamanData[child.key] = child.val();
        });
        
        // --- UPDATE TOTAL PEMINJAM SAAT DATA DITERIMA ---
        updateTotalPeminjam(Object.keys(allPeminjamanData).length);
        
        filterTable(); 
        
    } else {
        allPeminjamanData = {};
        renderCards({}); 
        updateTotalPeminjam(0);
        showStatus("Tidak ada data peminjaman aktif.", 'fas fa-inbox', true);
    }
}, error => {
    console.error("Error loading data from Firebase:", error);
    showStatus(`Gagal memuat data: ${error.message}`, 'fas fa-server', true);
});

// --- FUNGSI BARU: UPDATE TAMPILAN TOTAL PEMINJAM ---
function updateTotalPeminjam(count) {
    totalPeminjamDisplay.innerHTML = `<i class="fas fa-users"></i> Total Peminjam: ${count}`;
}

function renderCards(data) {
    container.innerHTML = "";
    const keys = Object.keys(data);

    if (keys.length === 0) {
        const filter = searchInput.value.toLowerCase().trim();
        if (filter.length > 0 && Object.keys(allPeminjamanData).length > 0) {
             showStatus(`Tidak ditemukan hasil untuk "${filter}".`, 'fas fa-search-minus', true);
        }
        return;
    }
    
    showStatus(null, null, false);

    for (const key in data) {
        const d = data[key];
        const card = document.createElement("div");
        card.className = "peminjam-card";
        
        const dendaInfo = hitungDenda(d.tanggalKembali);
        let dendaHTML = '';
        
        if (dendaInfo.terlambat) {
            card.classList.add('terlambat');
            dendaHTML = `
                <div class="denda-notification">
                    <i class="fas fa-exclamation-triangle"></i>
                    TERLAMBAT ${dendaInfo.hari} HARI! 
                    <br>Denda: ${dendaInfo.dendaFormatted}
                </div>
            `;
        }

        const cardHeaderHTML = `
            <div class="card-header">
                <p class="card-title"><i class="fas fa-user-tag" style="margin-right:8px; color:var(--primary-blue);"></i>${d.nama || '-'}</p>
                <p class="card-subtitle"><i class="fas fa-graduation-cap"></i> ${d.blok || '-'} | NIS: ${d.nis || '-'}</p>
            </div>
        `;
        
        const otherDetails = [
            `Pgr: ${d.pengarang || '-'}`,
            `Blok: ${d.blokBuku || '-'} / ${d.rak || '-'}`,
            `Inv: ${d.kode || '-'}`
        ].join(' | ');

        const detailHTML = `
            <div class="book-details-wrapper">
                
                <div class="card-detail main-judul">
                    <i class="fas fa-book" style="color:#3498db;"></i>
                    <span style="font-weight: 700; font-size: 1.05em; color: var(--text-dark);">${d.judul || 'Judul Tidak Tersedia'}</span>
                </div>

                <div class="card-detail other-details">
                    <i class="fas fa-info-circle" style="color:#7f8c8d;"></i>
                    <span style="color: var(--text-dark);">${otherDetails}</span>
                </div>
                
            </div>
        `;

        const datesHTML = `
            <div class="card-dates">
                <div class="date-item">
                    <button class="edit-date-btn" title="Edit Tgl Pinjam" onclick="handleEditTglPinjam('${key}', '${d.tanggalPinjam}')">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                    <div class="date-value">${d.tanggalPinjam || '-'}</div>
                    <span>Tgl. Pinjam</span>
                </div>
                <div class="date-item">
                    <button class="edit-date-btn" title="Edit Tgl Kembali" onclick="handleEditTglKembali('${key}', '${d.tanggalKembali}')">
                        <i class="fas fa-calendar-check" style="color:${dendaInfo.terlambat ? 'var(--danger-red)' : '#2ecc71'};"></i>
                    </button>
                    <div class="date-value">${d.tanggalKembali || '-'}</div>
                    <span>Tgl. Kembali</span>
                </div>
            </div>
        `;

        const actionsHTML = `
            <div class="card-actions">
                <button class="action-btn perpanjang-btn" onclick="handlePerpanjang('${key}')">
                    <i class="fas fa-redo-alt"></i> Perpanjang
                </button>
                <button class="action-btn kembali-btn" onclick="handleKembalikan('${key}', ${dendaInfo.denda})">
                    <i class="fas fa-undo"></i> Kembalikan
                </button>
            </div>
        `;
        
        card.innerHTML = cardHeaderHTML + detailHTML + datesHTML + dendaHTML + actionsHTML;
        container.appendChild(card);
    }
}


// --- FUNGSI AKSI (KEMBALIKAN & PERPANJANG) ---

function kembalikan(key) {
    db.ref(PEMINJAMAN_PATH + "/" + key).remove()
    .then(() => customAlert("✅ Pengembalian buku berhasil diproses!"))
    .catch(error => customAlert(`🚫 Error menghapus data: ${error.message}`));
}

function handleKembalikan(key, denda) {
    if (!allPeminjamanData[key]) {
         return customAlert("🚫 Error: Data peminjaman tidak ditemukan.");
    }
    
    let konfirmasiPesan = "Apakah Anda yakin ingin mengembalikan buku ini?";
    let isDanger = false;
    
    if (denda > 0) {
        konfirmasiPesan = `Buku terlambat! \nTotal denda yang harus dibayar: **${formatRupiah(denda)}**.\n\nApakah Anda yakin ingin menyelesaikan pengembalian ini?`;
        isDanger = true;
    }

    showCustomModal(konfirmasiPesan, () => kembalikan(key), isDanger);
}

function handlePerpanjang(key) {
    const dataPeminjam = allPeminjamanData[key];
    if (!dataPeminjam) return customAlert("🚫 Error: Data peminjaman tidak ditemukan.");

    const dendaInfo = hitungDenda(dataPeminjam.tanggalKembali);
    
    let peringatanDenda = "";
    if (dendaInfo.terlambat) {
        peringatanDenda = `⚠️ **PERINGATAN!** Anggota ini terlambat **${dendaInfo.hari} hari** dan memiliki denda **${dendaInfo.dendaFormatted}**.\n\nPerpanjangan ini **TIDAK** menghapus denda yang sudah ada. Denda tetap berlaku.\n\n`;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    today.setDate(today.getDate() + 4); 

    const newTglKembali = formatDate(today);
    const tglKembaliLamaStr = dataPeminjam.tanggalKembali;

    const konfirmasiPesan = `${peringatanDenda}Tanggal kembali saat ini: **${tglKembaliLamaStr}**.\n\nPerpanjangan dihitung **4 hari dari hari ini**.\n\nApakah Anda yakin ingin memperpanjang peminjaman ini hingga:\n\n**${newTglKembali}**?`;
    
    showCustomModal(konfirmasiPesan, () => {
        db.ref(PEMINJAMAN_PATH + "/"+key).update({
            tanggalKembali: newTglKembali
        })
        .then(() => customAlert(`🎉 Peminjaman berhasil diperpanjang!\nTanggal kembali baru: **${newTglKembali}**`))
        .catch(error => customAlert(`🚫 Error memperpanjang data: ${error.message}`));
    }, dendaInfo.terlambat); 
}

// Fitur Pencarian (Filtering)
function filterTable() {
    const filter = searchInput.value.toLowerCase().trim();
    const filteredData = {};

    for (const key in allPeminjamanData) {
        const d = allPeminjamanData[key];
        const searchableText = `${d.nama} ${d.blok} ${d.judul} ${d.pengarang} ${d.blokBuku} ${d.rak} ${d.nis} ${d.kode} ${d.tanggalPinjam} ${d.tanggalKembali}`.toLowerCase();
        
        if (searchableText.includes(filter)) {
            filteredData[key] = d;
        }
    }
    renderCards(filteredData);
}

// --- INITIALIZATION ---
window.onload = () => {
    // listener real-time sudah berjalan saat ini
};
</script>

</body>
</html>
