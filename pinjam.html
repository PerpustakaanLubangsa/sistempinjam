<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pustaka Cepat - Dark Cyan Professional</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-PZJ5vYq85qL/Jp/c20lC/y3jK7z5z4g+1q8d0tE+g7G2w7q2V2F6OQn9x5h0T6u2vOQ9/A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
/* --- VARIABEL DASAR (FOKUS DARK CYAN BARU) --- */
:root {
    --primary-color: #008b8b; /* Dark Cyan Baru */
    --accent-color: #008b8b; 
    --light-accent-color: #38b4b4; /* Dark Cyan yang sedikit lebih terang */
    --background-light: #ffffff;
    --background-dark: #f0f4f7; /* Background lebih cerah */
    --text-dark: #2c3e50; /* Darker text */
    --text-muted: #7f8c8d;
    --border-light: #e0e6eb;
    --shadow-subtle: 0 4px 18px rgba(0, 0, 0, 0.1); 
    --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
    --danger-color: #e74c3c;
    --success-color: #27ae60;
}

/* --- GLOBAL & LAYOUT --- */
body {
    font-family: 'Poppins', sans-serif;
    background: var(--background-dark); 
    margin: 0;
    padding: 30px 15px;
    color: var(--text-dark); 
    line-height: 1.6;
    transition: background-color 0.3s ease; 
}

.container {
    max-width: 800px;
    margin: auto;
    padding: 0;
}

/* --- JUDUL & HEADER --- */
.header-container {
    padding-bottom: 40px;
    text-align: center; 
}
.main-title {
    color: var(--primary-color); 
    font-size: 2.5em;
    font-weight: 700; 
    margin: 0;
    letter-spacing: -1px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.subtitle {
    color: var(--text-muted);
    font-size: 1.1em;
    margin-top: 10px;
}

/* --- FORM PENCARIAN & AUTOSUGGEST (FOKUS) --- */
.floating-search {
    padding-bottom: 50px;
}
.search-input-wrapper {
    position: relative;
    background: var(--background-light);
    border-radius: 12px; 
    box-shadow: var(--shadow-subtle);
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    cursor: text; 
    transition: all 0.4s ease; 
    padding: 0; 
}

.search-input-wrapper:focus-within {
    border-color: var(--light-accent-color); 
    box-shadow: 0 0 0 4px rgba(0, 139, 139, 0.1);
}

.autocomplete-container {
    position: relative; 
    width: 100%; 
}

input[type="text"]#nisInput {
    flex-grow: 1;
    padding: 18px 25px; 
    background: transparent;
    border: none;
    font-size: 1.15em;
    font-weight: 500;
    width: 100%; 
    box-sizing: border-box; 
}
input[type="text"]#nisInput:focus {
    outline: none;
}

/* OPTIMASI: Autocomplete Profesional */
.autocomplete-results {
    z-index: 10000; 
    position: absolute; 
    top: 100%; 
    left: 0;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    background: var(--background-light);
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    list-style-type: none;
    padding: 5px 0;
    margin-top: 10px;
    animation: fadeIn 0.3s ease; 
}
.autocomplete-item {
    padding: 12px 18px;
    cursor: pointer;
    font-size: 0.95em;
    transition: background 0.2s, color 0.2s, transform 0.2s;
    border-radius: 8px;
    margin: 4px 8px;
    position: relative;
}
.autocomplete-item:hover, .autocomplete-item.selected {
    background: var(--light-accent-color); 
    color: var(--background-light); 
    transform: translateX(0);
}
.autocomplete-item:hover b, .autocomplete-item.selected b {
    color: var(--background-light); 
}
.autocomplete-item:hover span, .autocomplete-item.selected span {
    color: rgba(255, 255, 255, 0.8); 
}
.autocomplete-item.selected::before {
    content: "\f00c"; 
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--background-light);
    font-size: 0.8em;
}


/* --- MODAL PROFIL PROFESIONAL --- */
#profilModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75); 
    justify-content: center;
    align-items: center;
    z-index: 1100;
    overflow-y: auto;
}

.modal-content {
    background: var(--background-light);
    width: 90%;
    max-width: 850px; 
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    max-height: 95vh;
    display: flex;
    flex-direction: column;
    opacity: 0;
    transform: translateY(-20px); 
    animation: modalSlideIn 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94); 
}

.modal-body {
    padding: 30px 40px;
    overflow-y: auto;
}

/* OPTIMASI: Tombol Tutup/Close Modal (Teks "Tutup") */
.close-btn {
    position: absolute;
    top: 25px; 
    right: 25px;
    padding: 8px 15px; 
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.2); 
    border: 2px solid rgba(255, 255, 255, 0.7); 
    
    width: auto; 
    height: auto;
    
    display: inline-block; 
    text-align: center;
    
    color: #fff; 
    font-size: 0.9em; 
    font-weight: 600; 
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 10; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.close-btn:hover {
    background: #fff;
    color: var(--primary-color); 
    border-color: #fff;
    transform: scale(1.05); 
}

/* Modal Header - Desain Kartu Profil */
.profil-header {
    background: var(--primary-color);
    background-image: linear-gradient(135deg, var(--primary-color) 0%, #00a0a0 100%); 
    padding: 35px 40px;
    color: #fff;
    position: relative;
    border-bottom: 5px solid var(--light-accent-color);
}
.profil-header h2 {
    font-size: 2em;
    font-weight: 700;
    margin: 0 0 5px 0;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
}
.profil-info {
    font-size: 1em;
    opacity: 0.9;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}
.profil-info b {
    font-weight: 600;
}

/* Status Tags */
.status-tag {
    padding: 4px 10px;
    border-radius: 50px;
    font-size: 0.8em;
    font-weight: 600;
    color: #fff;
    margin-left: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.status-meminjam { 
    background: var(--danger-color);
}
.status-aman { 
    background: var(--success-color);
}


.content-header {
    font-size: 1.4em;
    font-weight: 700;
    color: var(--text-dark); 
    margin-top: 40px;
    margin-bottom: 25px;
    border-left: 5px solid var(--primary-color);
    padding: 0 0 0 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.warning-box {
    padding: 18px; 
    background:#fff7ec; 
    border: 1px solid #ffcc80;
    border-left: 5px solid #ff9800;
    border-radius: 10px; 
    color:#e65100;
    margin-top: 25px;
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}
.warning-box b {
    font-weight: 700;
}

/* Pinjam Input Wrapper */
#pinjam-view {
    padding: 25px;
    border: 2px dashed var(--border-light);
    border-radius: 12px;
    background: var(--background-dark);
}
#pinjam-view.hidden {
    display: none;
}
input[type="text"]:not(#nisInput) {
    width: 100%;
    padding: 14px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
    box-sizing: border-box;
    font-size: 1em;
    transition: border-color 0.3s, box-shadow 0.3s;
}
input[type="text"]:not(#nisInput):focus {
    border-color: var(--primary-color); 
    outline: none;
    box-shadow: 0 0 0 4px rgba(0, 139, 139, 0.1);
}
label { 
    display: block; 
    margin-bottom: 8px; 
    font-weight: 600; 
    font-size: 0.95em; 
    color: var(--text-dark); 
}

/* Table Peminjaman Profesional */
.table-responsive { 
    overflow-x: auto; 
    margin-bottom: 20px; 
    border-radius: 10px; 
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); 
}
table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0; 
    font-size: 0.9em; 
    background: var(--background-light); 
    overflow: hidden;
}
th, td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
}
th { 
    background: var(--primary-color); 
    color: #fff; 
    font-weight: 600; 
    font-size: 0.9em; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
tr:nth-child(even) { background-color: var(--background-dark); }
tr:hover { background-color: #e0f7fa; transition: background-color 0.2s; }
td:first-child { font-weight: 700; color: var(--primary-color); }
.action-buttons-cell { display: flex; gap: 8px; }

/* Action Buttons */
.action-btn {
    padding: 8px 15px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85em;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.action-btn i {
    margin-right: 5px;
}
.kembali { 
    background: var(--danger-color); 
    color: #fff; 
} 
.kembali:hover { 
    background: #c0392b; 
    transform: translateY(-1px);
}
.perpanjang { 
    background: var(--success-color); 
    color: #fff; 
} 
.perpanjang:hover { 
    background: #219d53; 
    transform: translateY(-1px);
}

#pinjamBtn {
    background: var(--primary-color);
    color: #fff;
    padding: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    margin-top: 20px;
    transition: all 0.3s;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    box-shadow: 0 4px 10px rgba(0, 139, 139, 0.4);
}
#pinjamBtn:hover { 
    background: var(--light-accent-color); 
    box-shadow: 0 6px 15px rgba(0, 139, 139, 0.5);
    transform: translateY(-2px);
}
#pinjamBtn i { margin-right: 8px; }


/* Loading & Popups */
.loading {
    display: none;
    text-align: center;
    margin: 50px 0;
    font-weight: 600;
    color: var(--primary-color); 
    font-size: 1.4em;
    gap: 10px;
    align-items: center;
    justify-content: center;
}
.loading i {
    animation: spin 1.2s linear infinite;
}

.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1200;
}
.popup {
    background: var(--background-light);
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    box-shadow: var(--shadow-hover);
    transform: translateY(-50px);
    animation: popIn 0.3s forwards cubic-bezier(0.17, 0.84, 0.44, 1);
}
.popup i {
    font-size: 3.5em; 
    color: var(--primary-color); 
    margin-bottom: 25px;
    display: block;
}
#popupOk {
    background: var(--primary-color);
    color: #fff;
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 20px;
    font-weight: 600;
    transition: background 0.2s;
}
#popupOk:hover {
    background: var(--light-accent-color);
}
#popupCancel { /* Styling tambahan untuk tombol Batal */
    background: #95a5a6; 
    color: #fff; 
    padding: 12px 30px; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    margin-top: 20px; 
    margin-right: 10px; 
    font-weight: 600; 
    transition: background 0.2s;
}
#popupCancel:hover {
    background: #7f8c8d;
}

/* --- ANIMASI KEYFRAMES --- */
@keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-50px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes modalSlideOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-50px); }
}
@keyframes popIn {
    from { opacity: 0; transform: translateY(-50px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes popOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-50px); }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Media Queries */
@media (max-width: 768px) {
    .modal-body { padding: 20px; }
    .profil-header { padding: 25px 20px; }
    .profil-header h2 { font-size: 1.5em; }
    .profil-info { font-size: 0.9em; gap: 10px; }
    .main-title { font-size: 2em; }
    th, td { padding: 12px; font-size: 0.85em; }
    .action-buttons-cell { flex-direction: column; gap: 5px; }
    .action-btn { width: 100%; text-align: center; }
}
</style>
</head>
<body>
<div class="container">
    
    <div class="header-container">
        <h1 class="main-title">
            <i class="fas fa-book-open"></i> Pustaka Cepat
        </h1>
        <p class="subtitle">Sistem Peminjaman Buku Sekolah Cepat & Modern</p>
    </div>
    
    <div class="floating-search">
        <div class="search-input-wrapper" id="nisInputWrapper">
            <div class="autocomplete-container">
                <input type="text" id="nisInput" placeholder="Cari NIS, Nama, atau Blok Anggota (Tekan Enter)..." autocomplete="off">
                <div id="nisAutocomplete" class="autocomplete-results" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading"><i class="fas fa-spinner"></i> Sedang memuat data...</div>
    
</div>

<div id="profilModal">
    <div class="modal-content">
        <div id="modalHeaderContent"></div>
        <div class="modal-body" id="modalBodyContent"></div>
    </div>
</div>

<div class="popup-overlay" id="popup">
    <div class="popup">
        <i class="fas fa-info-circle"></i>
        <div id="popupMessage"></div>
        <button id="popupCancel" style="display:none;">Batal</button>
        <button id="popupOk">Tutup</button>
    </div>
</div>

<script>
// --- KONFIGURASI FIREBASE ---
const firebaseConfig = {
    // Masukkan kembali konfigurasi Anda
    apiKey: "AIzaSyByw2om-sKHqgCWBDJcE7FEtONoUoJbn9M",
    authDomain: "traying-29bf4.firebaseapp.com",
    databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
    projectId: "traying-29bf4",
    storageBucket: "traying-29bf4.appspot.com",
    messagingSenderId: "42080663883",
    appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- CACHED DOM ELEMENTS ---
const DOM = {
    loading: document.getElementById('loading'),
    nisInput: document.getElementById('nisInput'),
    profilModal: document.getElementById("profilModal"),
    modalHeader: document.getElementById("modalHeaderContent"),
    modalBody: document.getElementById("modalBodyContent"),
    popup: document.getElementById('popup'),
    popupMsg: document.getElementById('popupMessage'),
    popupBtn: document.getElementById('popupOk'),
    nisInputWrapper: document.getElementById('nisInputWrapper')
};

// --- STATE GLOBAL ---
let anggotaAktif = null;
let dataKeanggotaan = {}; 
let dataBuku = {}; 

// --- HELPER FUNCTIONS ---

// MODIFIKASI: Mengubah showPopup agar bisa menerima tombol Batal/Konfirmasi (actionMode)
function showPopup(msg, callbackOk = null, callbackCancel = null, actionBtnText = 'Tutup', actionMode = 'alert') {
    DOM.popupMsg.innerHTML = msg; 
    DOM.popup.style.display = 'flex';
    DOM.popup.querySelector('.popup').style.animation = 'popIn 0.3s forwards cubic-bezier(0.17, 0.84, 0.44, 1)';
    
    const popupBtn = DOM.popupBtn;
    const popupCancelBtn = document.getElementById('popupCancel');

    // Mengatur tombol Batal dan Konfirmasi
    if (actionMode === 'confirm') {
        popupBtn.style.display = 'inline-block';
        popupCancelBtn.style.display = 'inline-block';
        popupBtn.innerText = actionBtnText; // Biasanya 'Ya, Konfirmasi'
        popupCancelBtn.innerText = 'Batal';
    } else {
        // Mode default 'alert'
        popupBtn.style.display = 'inline-block';
        popupCancelBtn.style.display = 'none';
        popupBtn.innerText = actionBtnText; // Biasanya 'Tutup'
    }

    // Fungsi menutup pop-up
    const closePopup = (callback) => {
        const popupContent = DOM.popup.querySelector('.popup');
        popupContent.style.animation = 'popOut 0.3s forwards cubic-bezier(0.6, -0.28, 0.735, 0.045)';
        setTimeout(() => {
            DOM.popup.style.display = 'none';
            // Reset animasi untuk popIn berikutnya
            popupContent.style.animation = 'popIn 0.3s forwards cubic-bezier(0.17, 0.84, 0.44, 1)'; 
            if (callback) callback();
        }, 280);
    };

    // Handler tombol OK (Konfirmasi)
    popupBtn.onclick = () => {
        closePopup(callbackOk);
    };

    // Handler tombol Batal
    if (actionMode === 'confirm') {
        popupCancelBtn.onclick = () => {
            closePopup(callbackCancel); // Jika batal, tetap tutup pop-up dan panggil callbackCancel
        };
        // Fokuskan pada tombol Konfirmasi
        popupBtn.focus();
    } else {
        // Fokuskan pada tombol Tutup
        popupBtn.focus();
    }
}

function showLoading(show) {
    DOM.loading.style.display = show ? 'flex' : 'none'; 
}

function muatDataAwal() {
    showLoading(true);
    const promises = [
        // PATH BARU: keanggotaan_v2
        db.ref("keanggotaan_v2").once("value").then(snap => {
            snap.forEach(child => {
                dataKeanggotaan[child.key] = child.val();
            });
        }),
        // PATH BARU: buku_v2
        db.ref("buku_v2").once("value").then(snap => {
            snap.forEach(child => {
                // Tambahkan key (kode) ke dalam objek data buku agar mudah dicari di autocomplete
                const book = child.val();
                book.kode = child.key; 
                dataBuku[child.key] = book;
            });
        })
    ];

    Promise.all(promises).then(() => {
        showLoading(false);
        setupAutocomplete('nisInput', dataKeanggotaan, ['nis', 'keanggotaan', 'blok']);
    }).catch(error => {
        showLoading(false);
        showPopup("Gagal memuat data awal: " + error.message);
    });
}

function cekAnggota() {
    const nis = DOM.nisInput.value.trim();
    if (!nis) { 
        DOM.nisInput.focus();
        return; 
    }
    
    // PERCEPATAN 1: Kosongkan input dan tampilkan loading segera
    DOM.nisInput.value = '';
    showLoading(true);
    
    // PATH BARU: keanggotaan_v2
    db.ref("keanggotaan_v2/" + nis).once("value").then(snap => {
        if (snap.exists()) {
            anggotaAktif = { nis: nis, ...snap.val() };
            // Lanjutkan ke muatDipinjam tanpa mematikan loading
            muatDipinjam(); 
        } else {
            anggotaAktif = null;
            closeProfilModal();
            showLoading(false); // Matikan loading jika anggota tidak ditemukan
            showPopup(`Anggota **${nis}** tidak ditemukan! Pastikan NIS/Blok/Nama sudah benar.`);
        }
    }).catch(error => {
        closeProfilModal();
        showLoading(false);
        showPopup("Error saat cek anggota: " + error.message);
    });
}

function setupAutocomplete(inputId, sourceData, searchKeys) {
    const inputEl = document.getElementById(inputId);
    if (!inputEl) return;
    
    const resultsEl = document.getElementById(inputId.replace('Input', 'Autocomplete'));
    let selectedIndex = -1;
    const isBukuAutocomplete = inputId === 'kodeInput';
    
    // Fungsi baru untuk menutup hasil
    const closeResults = () => {
        resultsEl.style.display = 'none';
        selectedIndex = -1;
    };

    const renderResults = (matches) => {
        resultsEl.innerHTML = '';
        resultsEl.style.display = matches.length > 0 ? 'block' : 'none';
        selectedIndex = -1;

        matches.slice(0, 8).forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'autocomplete-item';

            const primaryKey = isBukuAutocomplete ? item.kode : item.nis;
            const secondaryKey = isBukuAutocomplete ? item.judul : item.keanggotaan;

            li.innerHTML = `<b>${primaryKey}</b> - ${secondaryKey} <span style="float:right; font-size:0.8em;">(${item.blok || 'Inventaris'})</span>`;

            li.onclick = () => {
                inputEl.value = primaryKey;
                closeResults(); 
                if (!isBukuAutocomplete) {
                    cekAnggota(); 
                } else {
                    handlePinjam();
                }
            };
            resultsEl.appendChild(li);
        });
    };

    inputEl.oninput = () => {
        const query = inputEl.value.toLowerCase().trim();
        if (query.length < 2) {
            closeResults(); 
            return;
        }

        const matches = Object.keys(sourceData).map(key => {
            return { ...sourceData[key], nis: sourceData[key].nis || key, kode: sourceData[key].kode || key };
        }).filter(item => {
            return searchKeys.some(key => String(item[key] || '').toLowerCase().includes(query));
        });

        renderResults(matches);
    };

    inputEl.onblur = () => {
        setTimeout(() => {
            closeResults(); 
        }, 200);
    };
    
    inputEl.onkeydown = (e) => {
        const items = resultsEl.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'Enter') {
            if (selectedIndex !== -1) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (inputEl.value.trim().length > 0 && !isBukuAutocomplete) {
                e.preventDefault();
                cekAnggota();
            } else if (inputEl.value.trim().length > 0 && isBukuAutocomplete) {
                e.preventDefault();
                handlePinjam();
            }
            return;
        }
        
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        }
        
        items.forEach((item, index) => {
            item.classList.remove('selected');
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            }
        });
    };
}

// Render Detail Profil
function tampilkanProfil(peminjamanData) {
    const nis = anggotaAktif.nis;
    const isMeminjam = Object.keys(peminjamanData).length > 0;
    
    // --- 1. RENDER HEADER MODAL ---
    const statusClass = isMeminjam ? 'status-meminjam' : 'status-aman';
    const statusText = isMeminjam ? 'Meminjam' : 'Tidak Meminjam';
    const totalBuku = Object.keys(peminjamanData).length;

    DOM.modalHeader.innerHTML = `
        <div class="profil-header">
            <button class="close-btn" onclick="closeProfilModal()" title="Tutup">Tutup</button>
            <h2>${anggotaAktif.keanggotaan}</h2>
            <div class="profil-info">
                <span><i class="fas fa-id-card"></i> NIS: <b>${nis}</b></span>
                <span><i class="fas fa-map-marker-alt"></i> Blok: ${anggotaAktif.blok}</span>
                <span><i class="fas fa-book"></i> Total Buku: ${totalBuku}</span>
                <span class="status-tag ${statusClass}"><i class="fas fa-circle" style="font-size: 0.6em; margin-right: 5px;"></i>${statusText}</span>
            </div>
        </div>
    `;
    
    // --- 2. RENDER BODY MODAL (BUKU DIPINJAM) ---
    let bodyContent = ``;

    if (isMeminjam) {
        bodyContent += `
            <h3 class="content-header"><i class="fas fa-book-reader"></i> Daftar Buku Dipinjam</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Kode</th>
                            <th>Judul</th>
                            <th>Jatuh Tempo</th>
                            <th>Denda</th>
                            <th style="min-width: 180px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        const hariIni = new Date();
        hariIni.setHours(0, 0, 0, 0);

        Object.keys(peminjamanData).forEach(key => {
            const d = peminjamanData[key];
            const tglKembali = new Date(d.tanggalKembali);
            let keterlambatan = 0, denda = 0;

            if (hariIni > tglKembali) {
                const selisihHari = Math.ceil((hariIni - tglKembali) / (1000 * 60 * 60 * 24));
                keterlambatan = selisihHari;
                denda = keterlambatan * 1000; 
            }
            const dendaStr = `Rp ${denda.toLocaleString('id-ID')}`;
            const tglKembaliStr = new Date(d.tanggalKembali).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            const terlambatBadge = keterlambatan > 0 ? `<span style="color:var(--danger-color); font-size:0.8em; display:block; font-weight: 600;">(${keterlambatan} hr terlambat)</span>` : '';
            const dendaStyle = denda > 0 ? 'color:var(--danger-color); font-weight: 700;' : 'color:var(--success-color); font-weight: 600;';
            
            // Cek apakah ada denda untuk tombol perpanjang
            const adaDenda = denda > 0;

            bodyContent += `
                <tr>
                    <td><b>${d.kode}</b></td>
                    <td>${d.judul}</td>
                    <td>${tglKembaliStr} ${terlambatBadge}</td>
                    <td style="${dendaStyle}">${dendaStr}</td>
                    <td class="action-buttons-cell">
                        <button class="action-btn kembali" title="Kembalikan Buku" onclick="kembalikan('${key}', ${denda})">
                            <i class="fas fa-undo"></i> Kembali
                        </button>
                        <button class="action-btn perpanjang" title="Perpanjang Peminjaman" onclick="perpanjangBuku('${key}', ${adaDenda})">
                            <i class="fas fa-sync-alt"></i> Perpanjang
                        </button>
                    </td>
                </tr>
            `;
        });

        bodyContent += `
                    </tbody>
                </table>
            </div>
        `;
    }

    // --- 3. RENDER INPUT PINJAM ---
    bodyContent += `
        <h3 class="content-header pinjam"><i class="fas fa-plus-circle"></i> Pinjam Buku Baru</h3>
        <div id="pinjam-view" class="${isMeminjam ? 'hidden' : ''}">
            <div class="autocomplete-container" style="margin-bottom: 15px;">
                <label for="kodeInput">Kode Inventaris / Judul Buku</label>
                <input type="text" id="kodeInput" placeholder="Ketik Kode atau Judul Buku" autocomplete="off">
                <div id="kodeAutocomplete" class="autocomplete-results" style="display:none;"></div>
            </div>
            <button id="pinjamBtn" type="button" style="width:100%;" onclick="handlePinjam()">
                <i class="fas fa-book-medical"></i> PINJAM SEKARANG
            </button>
        </div>
        ${isMeminjam ? `<div class="warning-box"><i class="fas fa-exclamation-circle"></i> **TIDAK BISA PINJAM BARU**. Anggota harus mengembalikan buku di atas terlebih dahulu.</div>` : ''}
    `;
    
    DOM.modalBody.innerHTML = bodyContent;
    DOM.profilModal.style.display = "flex";
    
    // Perubahan: Tutup dropdown autocomplete NIS (Permintaan user)
    const nisAutocompleteEl = document.getElementById('nisAutocomplete');
    if (nisAutocompleteEl) {
        nisAutocompleteEl.style.display = 'none';
    }
    
    // Setup ulang autocomplete
    if (!isMeminjam) {
        setupAutocomplete('kodeInput', dataBuku, ['kode', 'judul']);
        document.getElementById('kodeInput').focus();
    }
}

function closeProfilModal() {
    const modalContent = DOM.profilModal.querySelector('.modal-content');
    modalContent.style.animation = 'modalSlideOut 0.3s forwards cubic-bezier(0.55, 0.085, 0.68, 0.53)';
    
    setTimeout(() => {
        DOM.profilModal.style.display = "none";
        modalContent.style.animation = 'modalSlideIn 0.5s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94)'; 
    }, 280); 
    
    DOM.nisInput.focus();
}


function muatDipinjam() {
    if (!anggotaAktif) return;

    // PATH BARU: peminjaman_v2
    db.ref("peminjaman_v2").orderByChild("nis").equalTo(anggotaAktif.nis).once("value").then(snap => {
        
        const peminjamanData = snap.val() || {};
        
        // PERCEPATAN 2: Tampilkan profil dan baru matikan loading
        tampilkanProfil(peminjamanData);
        showLoading(false);

    }).catch(error => {
        showLoading(false);
        showPopup("Error saat memuat status peminjaman: " + error.message);
    });
}

function handlePinjam() {
    if (!anggotaAktif) { closeProfilModal(); showPopup("Silakan cek profil anggota terlebih dahulu!"); return; }
    const kodeInputEl = document.getElementById('kodeInput'); 
    const kode = kodeInputEl ? kodeInputEl.value.trim() : '';

    if (!kode) { showPopup("Masukkan kode inventaris!"); return; }

    showLoading(true);
    closeProfilModal(); 

    // PATH BARU: peminjaman_v2
    db.ref("peminjaman_v2").orderByChild("kode").equalTo(kode).once("value").then(snapCekPinjam => {
        if (snapCekPinjam.exists()) {
            showLoading(false);
            showPopup(`Buku dengan kode **${kode}** sedang dipinjam oleh anggota lain!`);
            return;
        }

        // PATH BARU: buku_v2
        db.ref("buku_v2/" + kode).once("value").then(snapBuku => {
            if (!snapBuku.exists()) {
                showLoading(false);
                showPopup(`Buku dengan kode **${kode}** tidak ditemukan!`);
                return;
            }
            
            const bookData = snapBuku.val();
            
            const today = new Date();
            const pinjam = today.toISOString().split("T")[0]; 
            const kembaliDate = new Date();
            kembaliDate.setDate(today.getDate() + 4); 
            const kembali = kembaliDate.toISOString().split("T")[0]; 

            const data = {
                nis: anggotaAktif.nis,
                nama: anggotaAktif.keanggotaan,
                blok: anggotaAktif.blok, // Blok Anggota
                tanggalPinjam: pinjam,
                tanggalKembali: kembali,
                
                kode: kode, 
                judul: bookData.judul,
                pengarang: bookData.pengarang, 
                blokBuku: bookData.blok, 
                rak: bookData.rak 
            };

            // PATH BARU: peminjaman_v2
            db.ref("peminjaman_v2").push(data).then(() => {
                showLoading(false);
                showPopup(`Peminjaman buku **${bookData.judul}** berhasil! Batas kembali: **${new Date(kembali).toLocaleDateString('id-ID')}**`, () => {
                    muatDipinjam(); 
                });
            }).catch(error => {
                showLoading(false);
                showPopup("Gagal menyimpan data peminjaman: " + error.message);
            });
        });
    }).catch(error => {
        showLoading(false);
        showPopup("Error saat cek pinjam: " + error.message);
    });
}

// Perubahan: Menambahkan konfirmasi untuk Kembalikan (Batal/Konfirmasi)
function kembalikan(key, denda) {
    let msg = "Apakah Anda yakin ingin **mengembalikan** buku ini? Tindakan ini tidak dapat dibatalkan.";
    let iconColor = 'var(--primary-color)';

    if (denda > 0) {
        msg = `<div style="color: var(--danger-color); font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Denda: Rp ${denda.toLocaleString('id-ID')}</div><br>Pastikan denda telah dibayar! Konfirmasi **pengembalian buku**?`;
        iconColor = 'var(--danger-color)';
    }

    // Set icon color sebelum menampilkan popup
    DOM.popup.querySelector('i').style.color = iconColor;

    // Tampilkan popup konfirmasi
    showPopup(
        msg, 
        // Callback OK: Lanjutkan Pengembalian
        () => {
            // Reset icon color
            DOM.popup.querySelector('i').style.color = 'var(--primary-color)';
            
            showLoading(true);
            // PATH BARU: peminjaman_v2
            db.ref("peminjaman_v2/" + key).remove().then(() => {
                showLoading(false);
                showPopup("âœ… Buku berhasil dikembalikan.", () => {
                    muatDipinjam(); 
                });
            }).catch(error => {
                showLoading(false);
                showPopup("Gagal mengembalikan buku: " + error.message);
            });
        }, 
        // Callback Cancel: Batal (Kembali ke modal profil)
        () => {
             // Reset icon color
            DOM.popup.querySelector('i').style.color = 'var(--primary-color)';
            muatDipinjam(); // Muat ulang/tutup pop-up, kembali ke modal profil
        },
        'Ya, Kembalikan', // Action Button Text
        'confirm' // Action Mode
    );
}

// Perubahan: Menambahkan konfirmasi untuk Perpanjang (Batal/Konfirmasi)
function perpanjangBuku(key, adaDenda) {
    // Pengecekan denda Dihapus. Perpanjangan diizinkan meskipun terlambat.

    let msg = `Apakah Anda yakin ingin **memperpanjang** peminjaman buku ini selama 4 hari lagi?`;
    
    // Tampilkan popup konfirmasi
    showPopup(
        msg, 
        // Callback OK: Lanjutkan Perpanjangan
        () => {
            closeProfilModal();
            showLoading(true);

            const kembaliBaru = new Date();
            kembaliBaru.setDate(kembaliBaru.getDate() + 4); 
            const tglKembaliBaruStr = kembaliBaru.toISOString().split("T")[0];

            // PATH BARU: peminjaman_v2
            db.ref("peminjaman_v2/" + key).update({
                tanggalKembali: tglKembaliBaruStr
            }).then(() => {
                showLoading(false);
                showPopup(`ðŸŽ‰ Buku **berhasil diperpanjang**! Tanggal kembali baru: **${new Date(tglKembaliBaruStr).toLocaleDateString('id-ID')}**`, () => {
                    muatDipinjam(); 
                });
            }).catch(error => {
                showLoading(false);
                showPopup("Gagal memperpanjang buku: " + error.message);
            });
        }, 
        // Callback Cancel: Batal (Kembali ke modal profil)
        () => {
            muatDipinjam(); // Muat ulang/tutup pop-up, kembali ke modal profil
        },
        'Ya, Perpanjang', // Action Button Text
        'confirm' // Action Mode
    );
}

// --- INITIALIZATION ---
window.onload = () => {
    // Memuat data awal berjalan paralel
    muatDataAwal(); 
    
    // Event Listener untuk "Click Outside"
    DOM.profilModal.addEventListener('click', function(e) {
        if (e.target === DOM.profilModal) {
            closeProfilModal();
        }
    });

    DOM.nisInputWrapper.addEventListener('click', () => {
        DOM.nisInput.focus();
    });
    
    DOM.nisInput.focus();
};
</script></body>
</html>
