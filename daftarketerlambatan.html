<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Daftar Keterlambatan - Lebar Penuh Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
/* --- Gaya Dasar --- */
*, *::before, *::after {
    box-sizing: border-box;
}

:root {
    --primary-blue: #3498db;
    --danger-red: #e74c3c;
    --success-green: #2ecc71;
    --text-dark: #2c3e50;
    --text-muted: #7f8c8d;
    --bg-light: #f4f7f6;
    --border-light: #eee;
}

body { 
    font-family: 'Poppins', sans-serif; 
    background: var(--bg-light); 
    margin: 0; 
    padding: 10px; 
    color: var(--text-dark); 
}

/* --- Header dan Tombol Aksi --- */
.header-container {
    width: 100%; 
    max-width: 100%; 
    margin: 0 auto 15px auto;
    padding: 0 10px; 
    display: flex;
    justify-content: space-between;
    align-items: center;
}

h2 {
    color: var(--text-dark);
    font-size: 1.6em; 
    margin: 0;
}

#totalTerlambat {
    background: var(--danger-red);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 1em;
    font-weight: 700;
}

/* Tombol Salin */
#copyToExcelBtn {
    padding: 8px 12px;
    background: var(--success-green);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    transition: background-color 0.2s;
}
#copyToExcelBtn:hover {
    background-color: #27ae60;
}
#copyToExcelBtn:disabled {
    background-color: #bdc3c7;
    cursor: not-allowed;
}

/* Pesan Status */
#statusMessage {
    text-align: center;
    padding: 20px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin: 20px auto;
    max-width: 600px;
    display: none;
    color: var(--text-muted);
}

/* --- Gaya Tabel --- */
.table-container {
    width: 100%;
    max-width: 100%; 
    overflow-x: hidden; 
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    padding: 5px; 
    margin: auto;
}

.terlambat-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em; 
}

.terlambat-table th, .terlambat-table td {
    padding: 8px 5px; 
    text-align: left;
    border-bottom: 1px solid var(--border-light);
    white-space: normal; 
}

.terlambat-table th {
    background-color: var(--primary-blue);
    color: #fff;
    font-weight: 600;
    text-transform: uppercase;
}

/* **ALOKASI LEBAR KOLOM (Total 100%)** */
.terlambat-table th:nth-child(1) { width: 4%; }   /* No */
.terlambat-table th:nth-child(2) { width: 18%; }  /* Nama Peminjam */
.terlambat-table th:nth-child(3) { width: 8%; }   /* Blok (Blok Peminjam) */
.terlambat-table th:nth-child(4) { width: 35%; }  /* Judul Buku */
.terlambat-table th:nth-child(5) { width: 15%; }  /* Pengarang */
.terlambat-table th:nth-child(6) { width: 7%; }   /* Hari (Hari Terlambat) */
.terlambat-table th:nth-child(7) { width: 13%; }  /* Total Denda */

.terlambat-table tr:hover {
    background-color: #f8f8f8;
}

.terlambat-table .terlambat-row {
    background-color: #fff3f3; 
}

/* Kolom Penting */
.kolom-nama { font-weight: 600; color: var(--text-dark); }
.kolom-denda { font-weight: 700; color: var(--danger-red); }
.kolom-hari { font-weight: 600; color: #d35400; text-align: center;} 

/* Responsif */
@media (max-width: 768px) {
    body { padding: 5px; }
    .header-container { flex-direction: column; align-items: flex-start; gap: 8px; padding: 0;}
    h2 { font-size: 1.4em; }
    .table-container { 
        overflow-x: auto; 
        padding: 5px;
    }
    .terlambat-table {
        min-width: 850px; 
    }
}
</style>
</head>
<body>

<div class="header-container">
    <h2><i class="fas fa-calendar-times" style="color:var(--danger-red); margin-right: 5px;"></i> Daftar Peminjaman Terlambat</h2>
    <div style="display: flex; align-items: center; gap: 10px;">
        <div id="totalTerlambat"><i class="fas fa-exclamation-triangle"></i> Total Keterlambatan: 0</div>
        <button id="copyToExcelBtn" disabled onclick="copyTableToClipboard()">
            <i class="fas fa-copy"></i> Salin ke Excel
        </button>
    </div>
</div>

<div id="statusMessage"></div>

<div class="table-container">
    <table class="terlambat-table" id="dataTerlambatTable">
        <thead>
            <tr>
                <th>No</th>
                <th>Nama Peminjam</th>
                <th>Blok</th>
                <th>Judul Buku</th>
                <th>Pengarang</th>
                <th>Hari</th>
                <th>Total Denda</th>
            </tr>
        </thead>
        <tbody id="terlambatTableBody">
            </tbody>
    </table>
</div>


<script>
// --- Konfigurasi Firebase (GANTI DENGAN KONFIGURASI ANDA) ---
const firebaseConfig = {
    apiKey: "AIzaSyByw2om-sKHqgCWBDJcE7FEtONoUoJbn9M",
    authDomain: "traying-29bf4.firebaseapp.com",
    databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
    projectId: "traying-29bf4",
    storageBucket: "traying-29bf4.appspot.com",
    messagingSenderId: "42080663883",
    appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const PEMINJAMAN_PATH = "peminjaman_v2"; 
const DENDA_PER_HARI = 1000; 

// --- ELEMEN UTAMA ---
const tableBody = document.getElementById("terlambatTableBody");
const statusMessage = document.getElementById('statusMessage');
const totalTerlambatDisplay = document.getElementById('totalTerlambat');
const copyBtn = document.getElementById('copyToExcelBtn');

// --- HELPER FUNCTIONS ---

function showStatus(message, isVisible = true) {
    statusMessage.innerHTML = message;
    statusMessage.style.display = isVisible ? 'block' : 'none';
    document.querySelector('.table-container').style.display = isVisible ? 'none' : 'block';
    copyBtn.disabled = isVisible; 
}

function formatRupiah(angka) {
    if (typeof angka !== 'number' || angka < 0) return 'Rp0';
    const reverse = Math.floor(angka).toString().split('').reverse().join('');
    const ribuan = reverse.match(/\d{1,3}/g);
    const result = ribuan.join('.').split('').reverse().join('');
    return 'Rp' + result;
}

function hitungDenda(tanggalKembaliStr) {
    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    
    const tglKembali = new Date(tanggalKembaliStr);
    tglKembali.setHours(0, 0, 0, 0); 

    const selisihMs = today.getTime() - tglKembali.getTime();
    
    let hariTerlambat = 0;
    if (selisihMs > 0) {
        hariTerlambat = Math.floor(selisihMs / (1000 * 60 * 60 * 24)); 
    }
    
    if (hariTerlambat > 0) {
        const totalDenda = hariTerlambat * DENDA_PER_HARI;
        return {
            terlambat: true,
            hari: hariTerlambat,
            denda: totalDenda,
            dendaFormatted: formatRupiah(totalDenda)
        };
    } else {
        return {
            terlambat: false,
            hari: 0,
            denda: 0
        };
    }
}


// --- FUNGSI RENDER TABEL ---

function renderTerlambatTable(data) {
    tableBody.innerHTML = "";
    let no = 1;
    let totalTerlambatCount = 0;

    for (const key in data) {
        const d = data[key];
        const dendaInfo = hitungDenda(d.tanggalKembali);
        
        if (dendaInfo.terlambat) {
            totalTerlambatCount++;
            const row = tableBody.insertRow();
            row.className = "terlambat-row";
            
            // Kolom 1: No
            row.insertCell().textContent = no++; 
            
            // Kolom 2: Nama Peminjam
            const cellNama = row.insertCell();
            cellNama.className = "kolom-nama";
            cellNama.textContent = d.nama || '-';

            // Kolom 3: Blok
            row.insertCell().textContent = d.blok || '-';

            // Kolom 4: Judul Buku
            row.insertCell().textContent = d.judul || '-';
            
            // Kolom 5: Pengarang
            row.insertCell().textContent = d.pengarang || '-';
            
            // Kolom 6: Hari
            const cellHariTerlambat = row.insertCell();
            cellHariTerlambat.className = "kolom-hari";
            cellHariTerlambat.textContent = `${dendaInfo.hari}`; 
            
            // Kolom 7: Total Denda
            const cellDenda = row.insertCell();
            cellDenda.className = "kolom-denda";
            cellDenda.textContent = dendaInfo.dendaFormatted;
        }
    }
    
    totalTerlambatDisplay.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Total Keterlambatan: ${totalTerlambatCount}`;

    if (totalTerlambatCount === 0) {
        showStatus(`<i class="fas fa-thumbs-up" style="color:var(--success-green);"></i> **SEMUA AMAN!** Tidak ada peminjaman yang terlambat saat ini.`);
    } else {
        showStatus("", false);
        copyBtn.disabled = false;
    }
}

// --- FUNGSI SALIN KE EXCEL (Clipboard) ---
function copyTableToClipboard() {
    const table = document.getElementById('dataTerlambatTable');
    
    if (!table) {
        alert("Error: Tabel tidak ditemukan.");
        return;
    }
    
    // 1. Buat elemen DIV temporer untuk menampung konten yang akan disalin
    const tempDiv = document.createElement('div');
    
    // 2. Kloning tabel, tetapi sebelum dikloning, modifikasi data denda
    const clonedTable = table.cloneNode(true);
    
    // Lakukan pembersihan format pada kloningan tabel
    clonedTable.querySelectorAll('tbody tr').forEach(row => {
        const dendaCell = row.cells[6]; // Kolom Total Denda adalah index 6
        const hariCell = row.cells[5];   // Kolom Hari adalah index 5
        
        // Bersihkan Total Denda (agar hanya angka)
        let dendaText = dendaCell.textContent.trim();
        dendaCell.textContent = dendaText.replace('Rp', '').replace(/\./g, '').replace(/,/g, '');
        
        // Bersihkan Hari (agar hanya angka)
        hariCell.textContent = parseInt(hariCell.textContent) || 0;
    });

    // 3. Masukkan tabel kloning yang sudah bersih ke DIV temporer
    tempDiv.appendChild(clonedTable);
    
    // 4. Masukkan DIV temporer ke body dan posisikan agar tidak terlihat
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    document.body.appendChild(tempDiv);
    
    // 5. Pilih konten dari DIV temporer
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(tempDiv);
    selection.removeAllRanges();
    selection.addRange(range);
    
    let success = false;
    try {
        // 6. Eksekusi perintah salin (metode yang paling universal untuk tabel HTML)
        success = document.execCommand('copy'); 
    } catch (err) {
        console.error('Gagal menyalin:', err);
    }
    
    // 7. Bersihkan: hapus elemen dan selection
    document.body.removeChild(tempDiv);
    selection.removeAllRanges();

    // 8. Beri umpan balik (feedback)
    if (success) {
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Berhasil Disalin!';
        setTimeout(() => {
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> Salin ke Excel';
        }, 3000);
    } else {
        // Coba gunakan navigator.clipboard sebagai fallback jika execCommand gagal
        const tempTextarea = document.createElement('textarea');
        tempTextarea.value = tempDiv.innerText; // Mengambil data sebagai teks tab-delimited fallback
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        
        navigator.clipboard.writeText(tempTextarea.value).then(() => {
             copyBtn.innerHTML = '<i class="fas fa-check"></i> Berhasil Salin (Fallback)!';
             document.body.removeChild(tempTextarea);
             setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Salin ke Excel';
             }, 3000);
        }).catch(() => {
             alert('Gagal menyalin data. Pastikan Anda memberikan izin clipboard.');
             document.body.removeChild(tempTextarea);
             copyBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Gagal Salin';
             setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Salin ke Excel';
             }, 3000);
        });
    }
}


// --- INITAL DATA LOAD ---
showStatus("<i class='fas fa-spinner fa-spin'></i> Memuat data keterlambatan...", true); 

db.ref(PEMINJAMAN_PATH).on("value", snap => {
    if (snap.exists()) {
        renderTerlambatTable(snap.val());
    } else {
        renderTerlambatTable({});
        showStatus(`<i class="fas fa-thumbs-up" style="color:var(--success-green);"></i> **SEMUA AMAN!** Tidak ada peminjaman yang terlambat saat ini.`);
    }
}, error => {
    console.error("Error loading data from Firebase:", error);
    showStatus(`Gagal memuat data: ${error.message}`);
});
</script>

</body>
</html>
