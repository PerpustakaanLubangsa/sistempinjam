<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Kembalikan Buku</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
body {margin:0;font-family:sans-serif;background:#e0f7fa;display:flex;justify-content:center;align-items:center;height:100vh;color:#00bcd4;}
.container {background:#fff;padding:40px 30px 30px 30px;border-radius:15px;box-shadow:0 8px 20px rgba(0,188,212,0.2);text-align:center;width:380px;animation:fadeIn 1s ease;}
h2 {margin-bottom:20px;font-weight:700;color:#00bcd4;animation:slideDown 0.8s ease;}
.input-card {margin:15px 0;}
.input-card input {width:90%;padding:10px;border-radius:10px;border:2px solid #00bcd4;outline:none;font-size:1em;display:block;margin:0 auto;}
.input-card input:focus {border-color:#00acc1;box-shadow:0 0 8px #00acc1;}
button {width:50%;padding:10px;margin-top:20px;border-radius:10px;border:none;background:#00bcd4;color:#fff;font-weight:bold;cursor:pointer;display:block;margin:auto;}
button:hover {background:#00acc1;transform:scale(1.05);}
@keyframes fadeIn {from {opacity:0;} to {opacity:1;}}
@keyframes slideDown {from {transform:translateY(-20px);opacity:0;} to {transform:translateY(0);opacity:1;}}

/* Pop Up */
.popup-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); display:flex;
    justify-content:center; align-items:center;
    z-index: 1000; display:none;
}
.popup {
    background:#fff; padding:25px; border-radius:15px;
    width:350px; text-align:left; box-shadow:0 5px 15px rgba(0,0,0,0.3);
    animation:fadeIn 0.3s ease;
}
.popup h3 {margin:0 0 15px;font-size:1.2em;color:#00bcd4;text-align:center;}
.popup .info-line {margin-bottom:8px;}
.popup .late {color:red; font-weight:bold;}
.popup button {
    width:90px; margin:0 10px; padding:8px;
    border:none; border-radius:8px; font-weight:bold; cursor:pointer;
}
.ok-btn {background:#00bcd4;color:#fff;}
.ok-btn:hover {background:#00acc1;}
</style>
</head>
<body>

<div class="container">
    <h2>Kembalikan Buku</h2>
    <div class="input-card"><input id="inventaris" type="text" placeholder="Kode Inventaris"></div>
    <button onclick="kembalikanBuku()">Kembalikan</button>
</div>

<!-- POPUP -->
<div id="popupOverlay" class="popup-overlay">
  <div class="popup" id="popupBox">
    <h3 id="popupTitle"></h3>
    <div id="popupMessage"></div>
    <div id="popupButtons" style="text-align:center;"></div>
  </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyByw2om-sKHqgCWBDJcE7FEtONoUoJbn9M",
    authDomain: "traying-29bf4.firebaseapp.com",
    databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
    projectId: "traying-29bf4",
    storageBucket: "traying-29bf4.appspot.com",
    messagingSenderId: "42080663883",
    appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Popup helper
function showPopup(title, content, buttons=[{text:"OK",action:closePopup}]) {
    document.getElementById('popupTitle').innerText = title;
    const msgDiv = document.getElementById('popupMessage');
    msgDiv.innerHTML = content;
    const btnContainer = document.getElementById('popupButtons');
    btnContainer.innerHTML = '';
    buttons.forEach((btn, idx)=>{
        const b = document.createElement('button');
        b.textContent = btn.text;
        b.className = "ok-btn";
        b.onclick = ()=>{ btn.action(); };
        btnContainer.appendChild(b);
        if(idx===0) b.focus();
    });
    document.getElementById('popupOverlay').style.display='flex';
    document.onkeydown = function(e){
        if(e.key==="Enter"){ buttons[0].action(); }
    };
}
function closePopup(){ 
    document.getElementById('popupOverlay').style.display='none'; 
    document.onkeydown = null;
}
function resetForm(){
    document.getElementById('inventaris').value='';
    document.getElementById('inventaris').focus();
}

// Kembalikan Buku
function kembalikanBuku() {
    const kode = document.getElementById('inventaris').value.trim();
    if(!kode){ 
        showPopup("Peringatan","Masukkan kode inventaris!"); 
        return; 
    }

    db.ref('peminjaman').orderByChild('kode').equalTo(kode).once('value', snapshot=>{
        if(snapshot.exists()){
            snapshot.forEach(childSnap=>{
                const data = childSnap.val();
                const hariIni = new Date(); hariIni.setHours(0,0,0,0);
                const tglKembali = new Date(data.tanggalKembali); tglKembali.setHours(0,0,0,0);

                let content = '';
                content += `<div class="info-line"><b>Nama:</b> ${data.nama}</div>`;
                content += `<div class="info-line"><b>Blok:</b> ${data.blok}</div>`;
                content += `<div class="info-line"><b>NIS:</b> ${data.nis}</div>`;
                content += `<div class="info-line"><b>Judul Buku:</b> ${data.judul}</div>`;
                content += `<div class="info-line"><b>Kode Inventaris:</b> ${data.kode}</div>`;
                content += `<div class="info-line"><b>Tanggal Pinjam:</b> ${data.tanggalPinjam}</div>`;
                content += `<div class="info-line"><b>Harus Dikembalikan:</b> ${data.tanggalKembali}</div>`;

                if(hariIni > tglKembali){
                    const diffDays = Math.floor((hariIni - tglKembali)/(1000*60*60*24));
                    const denda = diffDays * 1000;
                    content += `<div class="info-line late">Keterlambatan: ${diffDays} hari</div>`;
                    content += `<div class="info-line late">Denda: Rp${denda}</div>`;
                } else {
                    content += `<div class="info-line">Buku dikembalikan tepat waktu</div>`;
                }

                showPopup("Informasi", content, [{
                    text:"OK",
                    action:()=>{ 
                        childSnap.ref.remove(); 
                        closePopup(); 
                        resetForm(); 
                    }
                }]);
            });
        } else {
            showPopup("Gagal","Data inventaris tidak ditemukan atau sudah dikembalikan!");
        }
    });
}

// Auto fokus & Enter
window.onload = ()=>{ document.getElementById('inventaris').focus(); };
document.getElementById('inventaris').addEventListener('keydown', e=>{
    if(e.key==='Enter') kembalikanBuku();
});
</script>

</body>
</html>
