<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Peminjaman Khusus (Multi-Buku & Kustom Tanggal)</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
/* --- Warna Aksen Cyan Palet --- */
/* Primary Cyan: #00bcd4 */
/* Dark Cyan: #0097a7 */
/* Light Cyan: #e0f7fa */

/* --- Global Styles --- */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f4f8; /* Light modern background */
  margin: 0;
  padding: 30px;
  color: #263238; 
}

.container {
  max-width: 1000px; 
  margin: auto;
  background: #ffffff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
}

/* --- JUDUL --- */
.header-container {
    padding-bottom: 20px;
    margin-bottom: 30px;
    text-align: center; 
}

.main-title {
    color: #263238; 
    font-size: 2.5em;
    font-weight: 300; 
    margin: 0;
    padding-bottom: 0 !important;
    border-bottom: none !important; 
}

.title-underline {
    width: 150px; 
    height: 4px;
    background: #00bcd4; /* Aksen Cyan */
    margin: 8px auto 0 auto; 
    border-radius: 2px;
}

/* --- Form Elements --- */
label {
  display: block;
  margin-top: 15px;
  margin-bottom: 5px;
  font-weight: 600;
  color: #00bcd4; /* Aksen Cyan */
}

input[type="text"], input[type="date"] {
  width: calc(100% - 20px);
  padding: 10px;
  margin: 5px 0 10px 0;
  border-radius: 8px;
  border: 1px solid #b2dfdb;
  box-sizing: border-box;
  transition: border-color 0.3s;
}
input[type="text"]:focus, input[type="date"]:focus {
  border-color: #00bcd4; /* Aksen Cyan */
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.2);
}

button {
  padding: 10px 15px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: #00bcd4; /* Aksen Cyan */
  color: #fff;
  font-weight: 600;
  transition: background 0.3s, transform 0.1s;
}
button:hover {
  background: #0097a7; /* Dark Cyan Hover */
  transform: translateY(-1px);
}

/* Flexbox untuk baris input di tab pinjam */
.input-group {
    display: flex;
    gap: 15px; 
    align-items: flex-end; 
}

.input-group > div {
    flex-grow: 1;
}

.input-group input[type="text"], .input-group input[type="date"] {
    margin: 5px 0;
}

.add-btn {
    flex-shrink: 0; 
    width: 150px; 
    margin-bottom: 10px; 
}

/* --- Profile and Loading --- */
#profil {
  margin: 20px 0;
  padding: 15px;
  background: #e0f7fa; /* Light Cyan Background */
  border-left: 5px solid #00bcd4; /* Aksen Cyan */
  border-radius: 8px;
}

.loading {
  display: none;
  text-align: center;
  margin: 15px 0;
  font-weight: bold;
  color: #00bcd4; /* Aksen Cyan */
}

/* --- Tabs --- */
.tabs {
  display: flex;
  margin-top: 20px;
  border-bottom: 2px solid #b2dfdb;
}

.tab {
  flex: 1;
  text-align: center;
  padding: 12px;
  cursor: pointer;
  background: #f5f5f5;
  color: #455a64;
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
  transition: background 0.3s, color 0.3s;
}

.tab:hover {
  background: #e0e0e0;
}

.tab.active {
  background: #00bcd4; /* Aksen Cyan Active */
  color: #fff;
  border-bottom: 2px solid #00bcd4; 
}

.tab-content {
  display: none;
  margin-top: 15px;
  padding: 15px;
  background: #fff;
  border: 1px solid #b2dfdb;
  border-radius: 0 0 8px 8px;
}
.tab-content.active {
  display: block;
}

/* --- Table Styles --- */
table {
  width: 100%;
  border-collapse: separate; 
  border-spacing: 0;
  margin-top: 15px;
  font-size: 0.9em; 
}
th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #e0f2f1;
}
th {
  background: #e0f7fa; /* Light Cyan Table Header */
  color: #0097a7; /* Dark Cyan Text */
  font-weight: 600;
  text-align: center;
}
td {
  text-align: center;
  vertical-align: middle;
}
tr:last-child td {
  border-bottom: none;
}

.action-btn {
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: 500;
  margin: 2px;
}
.hapus-item {
  background: #ff9800; /* Orange - Hapus dari keranjang */
  color: #fff;
}
.hapus-item:hover {
  background: #fb8c00;
}
.selesai {
    background: #4caf50; /* Green */
    color: #fff;
}
.selesai:hover {
    background: #43a047;
}

/* --- Keranjang Peminjaman --- */
#keranjang {
    margin-top: 20px;
    padding: 15px;
    border: 1px dashed #00bcd4;
    border-radius: 8px;
    min-height: 50px;
}
#keranjang h4 {
    margin-top: 0;
    color: #0097a7;
    border-bottom: 1px solid #e0f7fa;
    padding-bottom: 5px;
}
.keranjang-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dotted #b2dfdb;
}
.keranjang-item:last-child {
    border-bottom: none;
}
.keranjang-item span {
    font-size: 0.9em;
}
/* --- Autocomplete Styles --- */
.autocomplete-container {
    position: relative;
    width: 100%; 
}

.autocomplete-results {
    position: absolute;
    z-index: 100;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #b2dfdb;
    border-top: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 0 0 8px 8px;
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.autocomplete-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #e0f2f1;
    font-size: 14px;
    color: #455a64;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover, .autocomplete-item.selected {
    background: #e0f7fa; /* Light Cyan Hover */
    color: #0097a7; /* Dark Cyan Text */
}
/* --- Popup Styles --- */
.popup-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(38, 50, 56, 0.7); 
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.popup {
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  width: 350px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.popup button {
  margin-top: 20px;
  width: 100px;
  background: #00bcd4; /* Aksen Cyan */
}

</style>
</head>
<body>
<div class="container">
  
  <div class="header-container">
    <h2 class="main-title">
      Sistem Peminjaman Khusus
    </h2>
    <div class="title-underline"></div>
  </div>

  <div class="autocomplete-container">
    <label for="nisInput">NIS Anggota</label>
    <input type="text" id="nisInput" placeholder="Ketik NIS, Nama, atau Blok...">
    <div id="nisAutocomplete" class="autocomplete-results" style="display:none;"></div>
  </div>
  <button id="cekBtn" style="width:100%;">Cek & Muat Profil</button>

  <div id="loading" class="loading">Sedang memuat...</div>

  <div id="profil" style="display:none;"></div>

  <div id="tabs">
    <div class="tabs">
      <div class="tab active" onclick="bukaTab('pinjam', this)">Buat Pinjaman Baru</div>
      <div class="tab" onclick="bukaTab('aktif', this)">Daftar Peminjaman Aktif</div>
    </div>

    <div id="pinjam" class="tab-content active">
      
      <div class="input-group">
        <div class="autocomplete-container">
            <label for="kodeInput">Kode Inventaris / Judul Buku</label>
            <input type="text" id="kodeInput" placeholder="Ketik Kode atau Judul Buku">
            <div id="kodeAutocomplete" class="autocomplete-results" style="display:none;"></div>
        </div>
        <div>
            <label for="tglKembaliInput">Tanggal Pengembalian (Wajib Diisi)</label>
            <input type="date" id="tglKembaliInput" required>
        </div>
        <button id="tambahBukuBtn" class="add-btn">Tambah Buku</button>
      </div>

      <div id="keranjang">
          <h4>Keranjang Pinjaman (Buku: <span id="jmlBukuKeranjang">0</span>)</h4>
          <ul id="listKeranjang" style="list-style-type: none; padding: 0;">
              <li style="text-align:center; color:#9e9e9e;">Silakan tambah buku ke keranjang.</li>
          </ul>
      </div>

      <button id="konfirmasiPinjamBtn" style="width:100%; margin-top:20px;" disabled>Konfirmasi Pinjam Semua Buku</button>
    </div>

    <div id="aktif" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>ID Transaksi</th>
            <th>NIS & Nama</th>
            <th>Tanggal Pinjam</th>
            <th>Total Buku</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="listPinjamanAktif"></tbody>
      </table>
      <p id="noTransaksi" style="text-align:center; margin-top:15px; font-style:italic; display:none;">Tidak ada transaksi peminjaman aktif.</p>

      <div id="detailPinjaman" style="margin-top:20px; border-top: 1px solid #b2dfdb; padding-top: 15px; display:none;">
          </div>
    </div>
  </div>
</div>

<div class="popup-overlay" id="popup">
  <div class="popup">
    <div id="popupMessage"></div>
    <button id="popupOk">OK</button>
  </div>
</div>

<script>
// --- KONFIGURASI FIREBASE ---
const firebaseConfig = {
  // ❗ GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI ❗
  apiKey: "AIzaSyByw2om-sKHqgCWBDJcE7FEtONoUoJbn9M", 
  authDomain: "traying-29bf4.firebaseapp.com",
  databaseURL: "https://traying-29bf4-default-rtdb.firebaseio.com",
  projectId: "traying-29bf4",
  storageBucket: "traying-29bf4.appspot.com",
  messagingSenderId: "42080663883",
  appId: "1:42080663883:web:58f28d5d1164204457d030"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- STATE GLOBAL ---
let anggotaAktif = null;
let dataKeanggotaan = {}; 
let dataBuku = {}; 
let keranjangPinjam = []; 
let activeTransactionId = null; 

// --- HELPER FUNCTIONS ---
function showPopup(msg, callback = null) {
  const popup = document.getElementById('popup');
  const btn = document.getElementById('popupOk');
  document.getElementById('popupMessage').innerHTML = msg; 
  popup.style.display = 'flex';
  btn.focus();
  btn.onclick = null;
  btn.onclick = () => {
    popup.style.display = 'none';
    if (callback) callback();
  };
  btn.onkeydown = (e) => { if (e.key === 'Enter') btn.click(); };
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function bukaTab(id, element) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
  element.classList.add("active");
  document.getElementById(id).classList.add("active");
  
  if (id === 'aktif') {
    muatPinjamanAktif();
    document.getElementById('detailPinjaman').style.display = 'none';
    activeTransactionId = null;
  } else if (id === 'pinjam') {
    document.getElementById('kodeInput').focus();
    renderKeranjang();
  }
}

function muatDataAwal() {
  showLoading(true);
  const promises = [
    db.ref("keanggotaan").once("value").then(snap => {
      dataKeanggotaan = {};
      snap.forEach(child => {
        dataKeanggotaan[child.key] = child.val();
      });
    }),
    db.ref("buku").once("value").then(snap => {
      dataBuku = {};
      snap.forEach(child => {
        dataBuku[child.key] = child.val();
      });
    })
  ];

  Promise.all(promises).then(() => {
    showLoading(false);
    setupAutocomplete('nisInput', dataKeanggotaan, ['nis', 'keanggotaan', 'blok']);
    setupAutocomplete('kodeInput', dataBuku, ['kode', 'judul']);
  }).catch(error => {
    showLoading(false);
    showPopup("Gagal memuat data awal: " + error.message);
  });
}

// --- AUTOCPMLETE LOGIC ---
function setupAutocomplete(inputId, sourceData, searchKeys) {
    const inputEl = document.getElementById(inputId);
    const resultsEl = document.getElementById(inputId.replace('Input', 'Autocomplete'));
    let selectedIndex = -1;

    const renderResults = (matches) => {
        resultsEl.innerHTML = '';
        resultsEl.style.display = matches.length > 0 ? 'block' : 'none';
        selectedIndex = -1;

        matches.slice(0, 8).forEach((item, index) => {
            const li = document.createElement('li');
            li.classList.add('autocomplete-item');

            const primaryKey = inputId === 'nisInput' ? item.nis : item.kode;
            const secondaryKey = inputId === 'nisInput' ? item.keanggotaan : item.judul;

            li.innerHTML = `<b>${primaryKey}</b> - ${secondaryKey} (${item.blok || 'Inventaris'})`;

            li.addEventListener('click', () => {
                inputEl.value = primaryKey;
                resultsEl.style.display = 'none';
                if (inputId === 'nisInput') {
                    document.getElementById('cekBtn').click();
                } else if (inputId === 'kodeInput') {
                    document.getElementById('tambahBukuBtn').focus();
                }
            });
            resultsEl.appendChild(li);
        });
    };

    inputEl.addEventListener('input', () => {
        const query = inputEl.value.toLowerCase().trim();
        if (query.length < 2) {
            resultsEl.style.display = 'none';
            return;
        }

        const matches = Object.keys(sourceData).map(key => {
            const item = { ...sourceData[key] };
            if (inputId === 'nisInput') item.nis = key;
            if (inputId === 'kodeInput') item.kode = key;
            return item;
        }).filter(item => {
            return searchKeys.some(key => {
                const value = String(item[key] || '').toLowerCase();
                return value.includes(query);
            });
        });

        renderResults(matches);
    });

    inputEl.addEventListener('blur', () => {
        setTimeout(() => {
            resultsEl.style.display = 'none';
        }, 200);
    });

    inputEl.addEventListener('keydown', (e) => {
        const items = resultsEl.querySelectorAll('.autocomplete-item');
        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        } else if (e.key === 'Enter') {
            if (selectedIndex !== -1) {
                e.preventDefault();
                items[selectedIndex].click();
            } else {
                if (resultsEl.style.display === 'none') {
                    if (inputId === 'nisInput') document.getElementById('cekBtn').click();
                    if (inputId === 'kodeInput') document.getElementById('tambahBukuBtn').click();
                }
            }
            return;
        }

        items.forEach((item, index) => {
            item.classList.remove('selected');
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            }
        });

        if (selectedIndex !== -1) {
            const text = items[selectedIndex].innerText.split(' - ')[0];
            inputEl.value = text;
        }
    });
}


// --- MAIN LOGIC ---

// 1. Cek Anggota
document.getElementById('cekBtn').addEventListener('click', () => {
  const nis = document.getElementById('nisInput').value.trim();
  if (!nis) { showPopup("Masukkan NIS!"); return; }

  showLoading(true);
  db.ref("keanggotaan/" + nis).once("value").then(snap => {
    showLoading(false);
    if (snap.exists()) {
      anggotaAktif = { nis: nis, ...snap.val() };
      document.getElementById("profil").style.display = "block";
      document.getElementById("profil").innerHTML =
        `<b>Profil Anggota Aktif</b><br>
        NIS: <b>${nis}</b><br>
        Nama: ${anggotaAktif.keanggotaan}<br>
        Blok: ${anggotaAktif.blok}`;
      // TAB DIANGGAP SUDAH TERLIHAT DARI AWAL
      keranjangPinjam = []; 
      renderKeranjang();
      bukaTab('pinjam', document.querySelector('.tab[onclick*="pinjam"]'));
    } else {
      anggotaAktif = null;
      document.getElementById("profil").style.display = "none";
      // document.getElementById("tabs").style.display = "none"; // JANGAN SEMBUNYIKAN TAB
      showPopup("Anggota tidak ditemukan!");
    }
  }).catch(error => {
    showLoading(false);
    showPopup("Error saat cek anggota: " + error.message);
  });
});

// 2. Tambah Buku ke Keranjang
document.getElementById('tambahBukuBtn').addEventListener('click', () => {
    if (!anggotaAktif) { showPopup("Silakan cek profil anggota terlebih dahulu!"); return; }
    const kode = document.getElementById('kodeInput').value.trim();
    const tglKembali = document.getElementById('tglKembaliInput').value;
    
    // Validasi Tanggal Wajib Diisi
    if (!kode) { showPopup("Masukkan Kode Inventaris!"); return; }
    if (!tglKembali) { showPopup("Tanggal Pengembalian wajib diisi!"); return; }

    const bukuData = dataBuku[kode];
    if (!bukuData) { showPopup(`Buku dengan kode '${kode}' tidak ditemukan!`); return; }
    
    if (keranjangPinjam.some(item => item.kode === kode)) {
        showPopup(`Buku dengan kode '${kode}' sudah ada di keranjang!`);
        return;
    }

    // Cek apakah buku sedang dipinjam
    showLoading(true);
    db.ref("pinjaman_khusus").once("value").then(snap => {
        showLoading(false);
        let sedangDipinjam = false;
        snap.forEach(transaksiSnap => {
            const items = transaksiSnap.val().items;
            if (items && Object.values(items).some(item => item.kode === kode && item.status !== 'kembali')) {
                sedangDipinjam = true;
            }
        });

        if (sedangDipinjam) {
            showPopup(`Buku dengan kode '${kode}' sedang dipinjam oleh anggota lain!`);
        } else {
            // Tambahkan ke keranjang
            keranjangPinjam.push({
                kode: kode,
                judul: bukuData.judul,
                tglKembali: tglKembali
            });
            document.getElementById('kodeInput').value = '';
            document.getElementById('kodeInput').focus();
            renderKeranjang();
        }
    }).catch(error => {
        showLoading(false);
        showPopup("Error saat cek status buku: " + error.message);
    });
});

// 3. Render Keranjang
function renderKeranjang() {
    const listKeranjang = document.getElementById('listKeranjang');
    const jmlBukuEl = document.getElementById('jmlBukuKeranjang');
    listKeranjang.innerHTML = '';
    jmlBukuEl.textContent = keranjangPinjam.length;

    if (keranjangPinjam.length === 0) {
        listKeranjang.innerHTML = '<li style="text-align:center; color:#9e9e9e;">Silakan tambah buku ke keranjang.</li>';
        document.getElementById('konfirmasiPinjamBtn').disabled = true;
        return;
    }

    document.getElementById('konfirmasiPinjamBtn').disabled = false;
    keranjangPinjam.forEach((item, index) => {
        const li = document.createElement('li');
        li.classList.add('keranjang-item');
        li.innerHTML = `
            <span><b>${item.kode}</b> - ${item.judul} (Kembali: ${item.tglKembali})</span>
            <button class="action-btn hapus-item" onclick="hapusDariKeranjang(${index})">Hapus</button>
        `;
        listKeranjang.appendChild(li);
    });
}

// 4. Hapus dari Keranjang
function hapusDariKeranjang(index) {
    keranjangPinjam.splice(index, 1);
    renderKeranjang();
}

// 5. Konfirmasi Pinjam
document.getElementById('konfirmasiPinjamBtn').addEventListener('click', () => {
    if (keranjangPinjam.length === 0) { showPopup("Keranjang pinjaman kosong!"); return; }

    showLoading(true);
    const today = new Date().toISOString().split("T")[0]; 

    const transactionRef = db.ref("pinjaman_khusus").push();

    const itemsData = {};
    keranjangPinjam.forEach((item, index) => {
        itemsData['item' + index] = {
            kode: item.kode,
            judul: item.judul,
            tanggalKembali: item.tglKembali,
            status: 'dipinjam' 
        };
    });

    const transactionData = {
        nis: anggotaAktif.nis,
        nama: anggotaAktif.keanggotaan,
        blok: anggotaAktif.blok,
        tanggalPinjam: today,
        totalBuku: keranjangPinjam.length,
        items: itemsData
    };

    transactionRef.set(transactionData).then(() => {
        showLoading(false);
        keranjangPinjam = []; 
        renderKeranjang();
        document.getElementById('tglKembaliInput').value = ''; 
        showPopup("Transaksi peminjaman berhasil dibuat!", () => {
            bukaTab('aktif', document.querySelector('.tab[onclick*="aktif"]'));
        });
    }).catch(error => {
        showLoading(false);
        showPopup("Gagal menyimpan transaksi peminjaman: " + error.message);
    });
});

// 6. Muat Pinjaman Aktif
function muatPinjamanAktif() {
    const tbody = document.getElementById("listPinjamanAktif");
    const noTransaksiEl = document.getElementById("noTransaksi");
    
    tbody.innerHTML = "";
    noTransaksiEl.style.display = "none";
    document.getElementById('detailPinjaman').style.display = 'none';

    showLoading(true);
    db.ref("pinjaman_khusus").on("value", snap => {
        showLoading(false);
        tbody.innerHTML = ""; 
        let transaksiCount = 0;

        snap.forEach(child => {
            const d = child.val();
            const transactionId = child.key;

            // Cek apakah ada buku yang masih berstatus 'dipinjam'
            const activeItems = d.items ? Object.values(d.items).filter(item => item.status === 'dipinjam') : [];
            
            if (activeItems.length > 0) {
                transaksiCount++;
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${transactionId}</td>
                    <td><b>${d.nis}</b><br>${d.nama}</td>
                    <td>${d.tanggalPinjam}</td>
                    <td>${activeItems.length}</td>
                    <td><button class="action-btn" onclick="muatDetail('${transactionId}')">Lihat Detail</button></td>
                `;
                tbody.appendChild(tr);
            }
        });

        if (transaksiCount === 0) {
            noTransaksiEl.style.display = "block";
        } else {
            noTransaksiEl.style.display = "none";
        }
    });
}

// 7. Muat Detail Transaksi
function muatDetail(transactionId) {
    activeTransactionId = transactionId;
    const detailEl = document.getElementById('detailPinjaman');
    detailEl.style.display = 'block';
    
    // Render ulang detail section dengan pencarian dan tombol multi-aksi
    detailEl.innerHTML = `
        <h4 style="color: #0097a7;">Detail Buku Transaksi <span id="detailIdDetail">${transactionId}</span></h4>
        <div class="input-group" style="margin-bottom: 15px; align-items: center;">
            <div style="flex-grow: 1;">
                <input type="text" id="cariDetailInput" placeholder="Cari Kode atau Judul Buku..." oninput="filterDetailBuku(this.value)">
            </div>
            <button class="action-btn selesai" id="kembalikanTerpilihBtn" style="flex-shrink: 0; width: auto; margin: 0 10px 0 0;" onclick="kembalikanTerpilih()">Kembalikan Buku Terpilih</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="checkAll" onclick="toggleCheckAll(this.checked)"></th>
                    <th>Kode Inventaris</th>
                    <th>Judul Buku</th>
                    <th>Tgl Kembali</th>
                    <th>Keterlambatan (Hari)</th>
                    <th>Denda (Rp)</th>
                </tr>
            </thead>
            <tbody id="listDetailBuku"></tbody>
        </table>
    `;

    showLoading(true);
    db.ref("pinjaman_khusus/" + transactionId).once("value").then(snap => {
        showLoading(false);
        const d = snap.val();
        renderDetailTable(d.items || {});
    }).catch(error => {
        showLoading(false);
        showPopup("Error saat memuat detail: " + error.message);
    });
}

// 8. Render Tabel Detail Buku (Fungsi terpisah untuk pencarian/filter)
function renderDetailTable(items, query = '') {
    const tbody = document.getElementById('listDetailBuku');
    tbody.innerHTML = '';
    const hariIni = new Date();
    hariIni.setHours(0, 0, 0, 0);
    const lowerQuery = query.toLowerCase().trim();

    const activeItems = Object.entries(items)
        .filter(([, item]) => item.status === 'dipinjam')
        .filter(([, item]) => 
            !lowerQuery || 
            item.kode.toLowerCase().includes(lowerQuery) || 
            item.judul.toLowerCase().includes(lowerQuery)
        );

    activeItems.forEach(([itemKey, item]) => {
        const tglKembali = new Date(item.tanggalKembali);
        let keterlambatan = 0, denda = 0;

        if (hariIni > tglKembali) {
            const selisihHari = Math.ceil((hariIni - tglKembali) / (1000 * 60 * 60 * 24));
            keterlambatan = selisihHari;
            denda = keterlambatan * 1000; // Denda Rp 1000 per hari
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><input type="checkbox" class="buku-checkbox" data-key="${itemKey}" data-denda="${denda}"></td>
            <td>${item.kode}</td>
            <td>${item.judul}</td>
            <td>${item.tanggalKembali}</td>
            <td>${keterlambatan}</td>
            <td>Rp ${denda.toLocaleString('id-ID')}</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Non-aktifkan tombol jika tidak ada buku aktif yang ditampilkan
    const btn = document.getElementById('kembalikanTerpilihBtn');
    if (btn) btn.disabled = activeItems.length === 0;

    // Reset checkAll status
    const checkAll = document.getElementById('checkAll');
    if(checkAll) checkAll.checked = false;
}

// 9. Filter Detail Buku (Dipanggil dari input pencarian)
function filterDetailBuku(query) {
    if (!activeTransactionId) return;

    db.ref("pinjaman_khusus/" + activeTransactionId + "/items").once("value").then(snap => {
        renderDetailTable(snap.val() || {}, query);
    });
}

// 10. Toggle Checkbox Semua
function toggleCheckAll(checked) {
    document.querySelectorAll('.buku-checkbox').forEach(checkbox => {
        checkbox.checked = checked;
    });
}


// 11. Kembalikan Buku Terpilih (Multi-aksi)
function kembalikanTerpilih() {
    const checkboxes = document.querySelectorAll('.buku-checkbox:checked');
    if (checkboxes.length === 0) {
        showPopup("Pilih minimal satu buku untuk dikembalikan!");
        return;
    }

    let totalDenda = 0;
    checkboxes.forEach(cb => {
        totalDenda += parseInt(cb.dataset.denda);
    });

    let msg = `Anda akan mengembalikan ${checkboxes.length} buku. Lanjutkan?`;
    if (totalDenda > 0) {
        msg = `Anda akan mengembalikan ${checkboxes.length} buku dengan total denda **Rp ${totalDenda.toLocaleString('id-ID')}**. Pastikan denda telah dibayar! Apakah Anda yakin?`;
    }

    showPopup(msg, () => {
        showLoading(true);
        const updates = {};
        checkboxes.forEach(cb => {
            const itemKey = cb.dataset.key;
            updates[`pinjaman_khusus/${activeTransactionId}/items/${itemKey}/status`] = 'kembali';
        });

        db.ref().update(updates).then(() => {
            // Setelah pengembalian, cek apakah semua buku sudah kembali
            return db.ref(`pinjaman_khusus/${activeTransactionId}/items`).once('value');
        }).then(itemsSnap => {
            const items = itemsSnap.val();
            const allReturned = Object.values(items).every(item => item.status === 'kembali');

            if (allReturned) {
                // Hapus transaksi jika semua sudah kembali
                return db.ref(`pinjaman_khusus/${activeTransactionId}`).remove().then(() => {
                    activeTransactionId = null;
                    showLoading(false);
                    showPopup("Semua buku telah dikembalikan, transaksi selesai!", () => {
                        bukaTab('aktif', document.querySelector('.tab[onclick*="aktif"]'));
                    });
                });
            } else {
                showLoading(false);
                showPopup(`${checkboxes.length} buku berhasil dikembalikan.`);
                muatDetail(activeTransactionId); // Muat ulang detail
            }
        }).catch(error => {
            showLoading(false);
            showPopup("Gagal mengembalikan buku: " + error.message);
        });
    });
}


// --- INITIALIZATION ---
window.onload = () => {
  muatDataAwal(); 
  document.getElementById('nisInput').focus();
  // Panggil muatPinjamanAktif() agar data tampil jika tab 'aktif' yang aktif default
  muatPinjamanAktif(); 
};
</script>
</body>
</html>